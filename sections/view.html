<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sección - MatemáticaWeb</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/section-editor.css">
    <style>
        /* Estilos para actividades */
        .activity-container {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        .activity-content {
            padding: 20px;
        }

        .activity-header {
            margin-bottom: 20px;
        }

        .activity-header h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: #0d6efd;
        }

        .activity-description {
            font-style: italic;
            color: #6c757d;
            margin-bottom: 20px;
        }

        .question-card {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .options-list {
            margin-top: 10px;
        }

        .form-check {
            margin-bottom: 10px;
        }

        .activity-feedback {
            margin-top: 20px;
        }

        .question-feedback .card {
            margin-bottom: 15px;
        }
    </style>
    <script src="../js/netlify-debug.js"></script>
    <script src="../js/content-loader.js"></script>
    <script src="../js/error-handler.js"></script>
    <script src="../js/polyfill.min.js"></script>
    <script src="../js/netlify-activity-handler.js"></script>
</head>
<body>
    <div id="header"></div>

    <main class="container mt-4">
        <div id="sectionContent">
            <nav aria-label="breadcrumb" class="mb-4">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="../index.html">Inicio</a></li>
                    <li class="breadcrumb-item"><a href="#" id="courseLink">Curso</a></li>
                    <li class="breadcrumb-item active" id="sectionTitle">Sección</li>
                </ol>
            </nav>

            <div class="row">
                <div class="col-md-8">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2 id="sectionTitleHeader">Cargando...</h2>
                        <div class="navigation-buttons">
                            <a href="#" id="backToCourseBtn" class="btn btn-outline-primary me-2">
                                <i class="fas fa-arrow-left"></i> Volver al curso
                            </a>
                            <a href="../index.html" class="btn btn-outline-secondary">
                                <i class="fas fa-home"></i> Inicio
                            </a>
                        </div>
                    </div>
                    <div class="section-preview" id="sectionPreview">
                        <div class="text-center py-5">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <p class="mt-3">Cargando contenido...</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="topic-sidebar">
                        <div class="topic-info">
                            <h4>Información del Tema</h4>
                            <div id="topicInfo">
                                <p class="text-muted">Cargando información del tema...</p>
                            </div>
                        </div>

                        <div class="other-sections mt-4">
                            <h4>Otras Secciones</h4>
                            <div id="otherSections">
                                <p class="text-muted">Cargando secciones...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="footer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/sample-data.js"></script>
    <script src="../js/data-persistence.js"></script>
    <script src="../js/data-manager.js"></script>
    <script src="../js/main.js"></script>
    <script>
        // Variables globales
        let currentSectionId = null;
        let currentTopicId = null;
        let currentSection = null;
        let currentTopic = null;

        document.addEventListener('DOMContentLoaded', async () => {
            loadComponent('header', '../components/header.html');
            loadComponent('footer', '../components/footer.html');

            // Inicializar sistema de persistencia antes de cargar los datos
            if (typeof initializeDataSystem === 'function') {
                console.log('Inicializando sistema de persistencia en sections/view.html...');
                await initializeDataSystem();
            }

            // Obtener los IDs de la URL
            const urlParams = new URLSearchParams(window.location.search);
            const idParam = urlParams.get('id');
            const topicIdParam = urlParams.get('topicId');

            console.log('Parámetros de URL:', { id: idParam, topicId: topicIdParam });

            // Convertir a números si es posible
            currentSectionId = idParam ? parseInt(idParam) : null;
            currentTopicId = topicIdParam ? parseInt(topicIdParam) : null;

            console.log('IDs convertidos:', { currentSectionId, currentTopicId });

            if (!currentSectionId || !currentTopicId) {
                showError('Parámetros incorrectos', 'No se pudo cargar la sección porque faltan parámetros.');
                return;
            }

            // Cargar los datos
            loadData();
        });

        function loadData() {
            try {
                console.log('Cargando datos para sección ID:', currentSectionId, 'en tema ID:', currentTopicId);

                // Obtener el tema
                currentTopic = DataManager.getTopicById(currentTopicId);
                if (!currentTopic) {
                    console.error('Tema no encontrado en DataManager:', currentTopicId);
                    showError('Tema no encontrado', 'El tema solicitado no existe.');
                    return;
                }

                console.log('Tema encontrado:', currentTopic.title);

                // Obtener la sección usando la nueva función de DataManager
                if (typeof DataManager !== 'undefined') {
                    console.log('Usando DataManager.getSectionById para buscar la sección...');
                    currentSection = DataManager.getSectionById(currentSectionId, currentTopicId);

                    if (currentSection) {
                        console.log('Sección encontrada:', currentSection.title);
                    }
                } else {
                    // Fallback al método anterior
                    console.log('DataManager no disponible, usando método alternativo...');

                    // Primero intentar obtener la sección desde el tema
                    if (currentTopic.sections && Array.isArray(currentTopic.sections)) {
                        console.log('Buscando sección en las secciones del tema...');
                        currentSection = currentTopic.sections.find(s => s.id == currentSectionId);
                        if (currentSection) {
                            console.log('Sección encontrada en el tema:', currentSection.title);
                        }
                    }

                    // Si no se encuentra en el tema, intentar obtenerla desde el sistema de persistencia
                    if (!currentSection && typeof DataPersistence !== 'undefined') {
                        console.log('Buscando sección en el sistema de persistencia...');
                        currentSection = DataPersistence.getData('sections', currentSectionId);

                        if (currentSection) {
                            console.log('Sección encontrada en persistencia:', currentSection.title);

                            // Verificar que la sección pertenezca al tema actual
                            if (currentSection.topicId && currentSection.topicId != currentTopicId) {
                                console.warn(`La sección ${currentSectionId} pertenece al tema ${currentSection.topicId}, no al tema ${currentTopicId}`);
                                currentSection = null;
                            }
                        } else {
                            console.error('Sección no encontrada en persistencia:', currentSectionId);
                        }
                    }
                }

                // Si aún no se encuentra, mostrar error
                if (!currentSection) {
                    showError('Sección no encontrada', 'La sección solicitada no existe o no pertenece a este tema.');
                    return;
                }

                // Obtener el curso
                const course = DataManager.getCourseById(currentTopic.courseId);
                if (!course) {
                    showError('Curso no encontrado', 'El curso asociado no existe.');
                    return;
                }

                // Actualizar la navegación
                document.title = `${currentSection.title} - MatemáticaWeb`;
                document.getElementById('sectionTitle').textContent = currentSection.title;
                document.getElementById('sectionTitleHeader').textContent = currentSection.title;

                const courseLink = document.getElementById('courseLink');
                courseLink.textContent = course.title;
                courseLink.href = `../courses/view.html?id=${course.id}`;

                // Configurar el botón para volver al curso
                const backToCourseBtn = document.getElementById('backToCourseBtn');
                backToCourseBtn.href = `../courses/view.html?id=${course.id}`;

                // Mostrar información del tema
                document.getElementById('topicInfo').innerHTML = `
                    <h5>${currentTopic.title}</h5>
                    <p>${currentTopic.description}</p>
                    <a href="../courses/view.html?id=${course.id}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-arrow-left"></i> Volver al curso
                    </a>
                `;

                // Mostrar otras secciones del tema
                let otherSections = [];

                // Obtener secciones del tema
                if (currentTopic.sections && Array.isArray(currentTopic.sections)) {
                    otherSections = currentTopic.sections.filter(s => s.id != currentSectionId);
                }

                // Si no hay secciones en el tema o son pocas, intentar obtenerlas del sistema de persistencia
                if (otherSections.length === 0 && typeof DataPersistence !== 'undefined') {
                    console.log('Buscando otras secciones en el sistema de persistencia...');
                    const allSections = DataPersistence.getAllDataAsArray('sections');

                    // Filtrar secciones que pertenezcan al tema actual y no sean la sección actual
                    otherSections = allSections.filter(s => s.topicId == currentTopicId && s.id != currentSectionId);
                    console.log(`Encontradas ${otherSections.length} secciones adicionales en el sistema de persistencia`);
                }

                const otherSectionsHtml = otherSections.map(section => `
                    <div class="other-section-item">
                        <a href="view.html?id=${section.id}&topicId=${currentTopicId}" class="other-section-link">
                            <i class="${getSectionIcon(section.type)}"></i>
                            ${section.title}
                        </a>
                    </div>
                `).join('');

                document.getElementById('otherSections').innerHTML = otherSectionsHtml ||
                    '<p class="text-muted">No hay más secciones en este tema.</p>';

                // Mostrar el contenido de la sección
                renderSectionContent();
            } catch (error) {
                console.error('Error al cargar los datos:', error);
                showError('Error', 'Ocurrió un error al cargar el contenido.');
            }
        }

        function renderSectionContent() {
            console.log('Renderizando contenido de la sección:', currentSection.title);
            const sectionPreview = document.getElementById('sectionPreview');

            // Crear el encabezado de la sección
            const headerHtml = `
                <div class="section-preview-header">
                    <div class="section-preview-icon">
                        <i class="${getSectionIcon(currentSection.type)}"></i>
                    </div>
                    <h2 class="section-preview-title">${currentSection.title}</h2>
                </div>
            `;

            // Crear el contenido según el tipo
            let contentHtml = '';

            switch (currentSection.type) {
                case 'text':
                    contentHtml = `
                        <div class="section-preview-content text-content">
                            ${currentSection.content}
                        </div>
                    `;
                    break;

                case 'youtube':
                    contentHtml = `
                        <div class="section-preview-content">
                            <div class="youtube-container">
                                <iframe src="https://www.youtube.com/embed/${currentSection.content}"
                                        frameborder="0" allowfullscreen style="width:100%; height:400px;"></iframe>
                            </div>
                        </div>
                    `;
                    break;

                case 'geogebra':
                    contentHtml = `
                        <div class="section-preview-content">
                            <div class="geogebra-container">
                                <iframe src="https://www.geogebra.org/material/iframe/id/${currentSection.content}"
                                        frameborder="0" style="width:100%; height:500px;"></iframe>
                            </div>
                        </div>
                    `;
                    break;

                case 'image':
                    contentHtml = `
                        <div class="section-preview-content">
                            <div class="image-container">
                                <img src="${currentSection.content}" alt="${currentSection.title}">
                            </div>
                        </div>
                    `;
                    break;

                case 'pdf':
                    contentHtml = `
                        <div class="section-preview-content">
                            <div class="pdf-container">
                                <a href="${currentSection.content}" target="_blank" download>
                                    <i class="fas fa-file-pdf"></i> Descargar PDF
                                </a>
                            </div>
                        </div>
                    `;
                    break;

                case 'html':
                    // Verificar si el archivo existe
                    // Usar rutas absolutas para Netlify
                    const isNetlifyEnv = window.location.hostname.includes('netlify.app') ||
                                       window.location.hostname.includes('netlify.com');

                    // Construir la ruta base dependiendo del entorno
                    const basePath = isNetlifyEnv ?
                        (window.location.origin + '/activities/html/') :
                        '../activities/html/';

                    const htmlPath = basePath + currentSection.content;
                    const fallbackHtmlPath = basePath + 'ejemplo-simple.html';

                    console.log('Ruta HTML:', htmlPath);
                    console.log('Ruta fallback HTML:', fallbackHtmlPath);

                    // Detectar si estamos en Netlify
                    const isNetlify = window.location.hostname.includes('netlify.app') ||
                                     window.location.hostname.includes('netlify.com');

                    console.log('Cargando HTML en ' + (isNetlify ? 'Netlify' : 'Local') + ': ' + htmlPath);
                    console.log('Tipo de contenido de la sección:', currentSection.type);
                    console.log('Contenido de la sección:', currentSection.content);

                    // En Netlify, usar iframe como antes (ya que el HTML estático funciona bien en Netlify)
                    if (isNetlify) {
                        console.log('Entorno Netlify detectado, cargando HTML con iframe');

                        // Crear un ID único para el contenedor
                        const containerId = 'html-container-section';

                        // Crear el contenedor para el contenido HTML
                        contentHtml = `
                            <div class="section-preview-content">
                                <div class="html-container">
                                    <div id="${containerId}" class="html-content" style="min-height:400px;"></div>
                                </div>
                            </div>
                        `;

                        // Cargar el contenido HTML usando AJAX en lugar de iframe
                        setTimeout(() => {
                            console.log('Cargando contenido HTML usando AJAX:', htmlPath);
                            loadHTMLContent(htmlPath, containerId, fallbackHtmlPath);
                        }, 100);
                    } else {
                        // En local, usar iframe como antes
                        contentHtml = `
                            <div class="section-preview-content">
                                <div class="html-container">
                                    <iframe src="${htmlPath}" frameborder="0" style="width:100%; height:500px;"
                                            id="html-iframe-section"></iframe>
                                </div>
                            </div>
                        `;

                        // Verificar si el archivo existe
                        setTimeout(() => {
                            const iframe = document.getElementById('html-iframe-section');
                            if (iframe) {
                                fetch(htmlPath, { method: 'HEAD', cache: 'no-store' })
                                    .then(response => {
                                        if (!response.ok) {
                                            console.warn('Archivo ' + htmlPath + ' no encontrado, usando fallback');
                                            iframe.src = fallbackHtmlPath;
                                        }
                                    })
                                    .catch(error => {
                                        console.error('Error verificando archivo ' + htmlPath + ':', error);
                                        iframe.src = fallbackHtmlPath;
                                    });
                            }
                        }, 500);
                    }
                    break;

                case 'activity':
                    console.log('Renderizando actividad con ID:', currentSection.content);

                    // Limpiar el ID de la actividad (quitar prefijo si existe)
                    const activityId = currentSection.content.replace('activity_', '');
                    const activityKey = `activity_${activityId}`;

                    // Crear un ID único para el contenedor
                    const containerId = `activity-container-${currentSection.id}`;

                    // Intentar cargar la actividad desde localStorage
                    let activityData = null;
                    try {
                        activityData = JSON.parse(localStorage.getItem(activityKey));
                        console.log('Actividad cargada desde localStorage:', activityData ? 'Sí' : 'No');
                    } catch (e) {
                        console.error('Error al cargar actividad desde localStorage:', e);
                    }

                    if (activityData) {
                        // Generar HTML para la actividad
                        contentHtml = `
                            <div class="section-preview-content">
                                <table class="activity-container" cellpadding="0" cellspacing="0" border="0" width="100%">
                                    <tr>
                                        <td>
                                            <div id="${containerId}" class="activity-content">
                                                <div class="activity-header">
                                                    <h3>${activityData.title || 'Actividad sin título'}</h3>
                                                    <p class="activity-description">${activityData.description || ''}</p>
                                                </div>
                                                <form id="activity-form-${currentSection.id}" class="activity-form">
                                                    ${renderActivityQuestions(activityData, currentSection.id)}
                                                    <div class="d-grid gap-2 col-md-6 mx-auto mt-4">
                                                        <button type="button" class="btn btn-success btn-lg" onclick="checkActivityAnswers('${currentSection.id}', '${activityId}')">
                                                            <i class="fas fa-paper-plane me-2"></i> Enviar respuestas
                                                        </button>
                                                    </div>
                                                </form>
                                                <div id="activity-feedback-${currentSection.id}" class="activity-feedback mt-3" style="display:none;"></div>
                                            </div>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        `;
                    } else {
                        // Mostrar mensaje de error si no se encuentra la actividad
                        contentHtml = `
                            <div class="section-preview-content">
                                <table class="activity-container" cellpadding="0" cellspacing="0" border="0" width="100%">
                                    <tr>
                                        <td>
                                            <div class="alert alert-warning">
                                                <i class="fas fa-exclamation-triangle me-2"></i>
                                                <strong>Actividad no encontrada</strong>
                                                <p>No se pudo cargar la actividad con ID: ${activityId}</p>
                                            </div>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        `;
                    }
                    break;

                default:
                    contentHtml = `
                        <div class="section-preview-content">
                            <p class="text-muted">Tipo de contenido no soportado.</p>
                        </div>
                    `;
            }

            // Mostrar el contenido
            console.log('Actualizando contenido en el DOM');
            sectionPreview.innerHTML = headerHtml + contentHtml;
        }

        function showError(title, message) {
            document.getElementById('sectionPreview').innerHTML = `
                <div class="alert alert-danger">
                    <h4>${title}</h4>
                    <p>${message}</p>
                    <a href="../index.html" class="btn btn-outline-primary mt-3">
                        <i class="fas fa-home"></i> Volver al inicio
                    </a>
                </div>
            `;

            document.getElementById('topicInfo').innerHTML = `
                <p class="text-muted">Información no disponible</p>
            `;

            document.getElementById('otherSections').innerHTML = `
                <p class="text-muted">Información no disponible</p>
            `;
        }

        function getSectionIcon(type) {
            switch (type) {
                case 'text':
                    return 'fas fa-align-left';
                case 'youtube':
                    return 'fab fa-youtube';
                case 'geogebra':
                    return 'fas fa-calculator';
                case 'image':
                    return 'fas fa-image';
                case 'pdf':
                    return 'fas fa-file-pdf';
                case 'activity':
                    return 'fas fa-tasks';
                default:
                    return 'fas fa-file';
            }
        }

        /**
         * Renderiza las preguntas de una actividad
         */
        function renderActivityQuestions(activityData, sectionId) {
            if (!activityData || !activityData.questions || !Array.isArray(activityData.questions)) {
                return '<div class="alert alert-warning">Esta actividad no tiene preguntas.</div>';
            }

            let questionsHtml = '';

            activityData.questions.forEach((question, index) => {
                questionsHtml += `
                    <div class="question-card mb-3" data-question-index="${index}">
                        <p class="fw-bold mb-2">${index + 1}. ${question.text || 'Sin texto'}</p>
                `;

                // Renderizar según el tipo de pregunta
                if (activityData.type === 'multiple-choice') {
                    questionsHtml += '<div class="options-list">';

                    if (question.options && Array.isArray(question.options)) {
                        question.options.forEach((option, optionIndex) => {
                            questionsHtml += `
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="question_${sectionId}_${index}"
                                           id="option_${sectionId}_${index}_${optionIndex}" value="${optionIndex}">
                                    <label class="form-check-label" for="option_${sectionId}_${index}_${optionIndex}">
                                        ${option}
                                    </label>
                                </div>
                            `;
                        });
                    }

                    questionsHtml += '</div>';
                } else if (activityData.type === 'true-false') {
                    questionsHtml += `
                        <div class="options-list">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="question_${sectionId}_${index}"
                                       id="option_${sectionId}_${index}_true" value="true">
                                <label class="form-check-label" for="option_${sectionId}_${index}_true">
                                    Verdadero
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="question_${sectionId}_${index}"
                                       id="option_${sectionId}_${index}_false" value="false">
                                <label class="form-check-label" for="option_${sectionId}_${index}_false">
                                    Falso
                                </label>
                            </div>
                        </div>
                    `;
                } else if (activityData.type === 'short-answer') {
                    questionsHtml += `
                        <div class="form-group">
                            <input type="text" class="form-control" name="question_${sectionId}_${index}"
                                   placeholder="Tu respuesta" style="max-width: 400px;">
                        </div>
                    `;
                }

                questionsHtml += '</div>';
            });

            return questionsHtml;
        }

        /**
         * Verifica las respuestas de una actividad
         */
        function checkActivityAnswers(sectionId, activityId) {
            console.log(`Verificando respuestas para actividad ${activityId} en sección ${sectionId}`);

            // Obtener los datos de la actividad
            const activityKey = `activity_${activityId}`;
            let activityData;

            try {
                activityData = JSON.parse(localStorage.getItem(activityKey));
            } catch (e) {
                console.error('Error al cargar actividad:', e);
                showActivityFeedback(sectionId, 'error', 'Error al cargar la actividad.');
                return;
            }

            if (!activityData || !activityData.questions || !Array.isArray(activityData.questions)) {
                showActivityFeedback(sectionId, 'error', 'La actividad no tiene preguntas válidas.');
                return;
            }

            // Obtener las respuestas del usuario
            const form = document.getElementById(`activity-form-${sectionId}`);
            const userAnswers = [];
            let allAnswered = true;

            activityData.questions.forEach((question, index) => {
                const inputName = `question_${sectionId}_${index}`;
                let userAnswer;

                if (activityData.type === 'multiple-choice' || activityData.type === 'true-false') {
                    const selectedOption = form.querySelector(`input[name="${inputName}"]:checked`);
                    if (selectedOption) {
                        userAnswer = selectedOption.value;
                    } else {
                        allAnswered = false;
                    }
                } else if (activityData.type === 'short-answer') {
                    const inputField = form.querySelector(`input[name="${inputName}"]`);
                    if (inputField && inputField.value.trim()) {
                        userAnswer = inputField.value.trim();
                    } else {
                        allAnswered = false;
                    }
                }

                userAnswers.push({
                    questionIndex: index,
                    answer: userAnswer,
                    correct: false
                });
            });

            if (!allAnswered) {
                showActivityFeedback(sectionId, 'warning', 'Por favor, responde todas las preguntas.');
                return;
            }

            // Verificar las respuestas
            let correctCount = 0;

            userAnswers.forEach(userAnswer => {
                const question = activityData.questions[userAnswer.questionIndex];

                if (activityData.type === 'multiple-choice') {
                    // Para opción múltiple, la respuesta correcta es el índice de la opción correcta
                    if (question.correctAnswer !== undefined && userAnswer.answer == question.correctAnswer) {
                        userAnswer.correct = true;
                        correctCount++;
                    }
                } else if (activityData.type === 'true-false') {
                    // Para verdadero/falso, la respuesta correcta es un booleano
                    const correctAnswerStr = String(question.correctAnswer).toLowerCase();
                    const userAnswerStr = String(userAnswer.answer).toLowerCase();

                    if (correctAnswerStr === userAnswerStr) {
                        userAnswer.correct = true;
                        correctCount++;
                    }
                } else if (activityData.type === 'short-answer') {
                    // Para respuesta corta, comparamos ignorando mayúsculas/minúsculas
                    if (question.correctAnswer !== undefined) {
                        const correctAnswerStr = String(question.correctAnswer).toLowerCase();
                        const userAnswerStr = String(userAnswer.answer).toLowerCase();

                        if (correctAnswerStr === userAnswerStr) {
                            userAnswer.correct = true;
                            correctCount++;
                        }
                    }
                }
            });

            // Calcular porcentaje de aciertos
            const totalQuestions = activityData.questions.length;
            const percentage = Math.round((correctCount / totalQuestions) * 100);

            // Mostrar resultados
            let feedbackHtml = '';

            if (totalQuestions === 1) {
                // Si solo hay una pregunta, mostrar mensaje simple
                if (correctCount === 1) {
                    feedbackHtml = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>¡Correcto!</strong> Has respondido correctamente.
                        </div>
                    `;
                } else {
                    feedbackHtml = `
                        <div class="alert alert-danger">
                            <i class="fas fa-times-circle me-2"></i>
                            <strong>Incorrecto.</strong> La respuesta correcta es: ${getCorrectAnswerText(activityData, 0)}.
                        </div>
                    `;
                }
            } else {
                // Si hay múltiples preguntas, mostrar porcentaje y detalles
                let alertClass = 'alert-info';
                if (percentage >= 80) alertClass = 'alert-success';
                else if (percentage >= 50) alertClass = 'alert-warning';
                else alertClass = 'alert-danger';

                feedbackHtml = `
                    <div class="alert ${alertClass}">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Resultado:</strong> Has acertado ${correctCount} de ${totalQuestions} preguntas (${percentage}%).
                    </div>
                    <div class="question-feedback">
                `;

                userAnswers.forEach(userAnswer => {
                    const questionIndex = userAnswer.questionIndex;
                    const question = activityData.questions[questionIndex];

                    if (!userAnswer.correct) {
                        feedbackHtml += `
                            <div class="card mb-2">
                                <div class="card-body">
                                    <p class="mb-1"><strong>Pregunta ${questionIndex + 1}:</strong> ${question.text}</p>
                                    <p class="mb-1"><strong>Tu respuesta:</strong> ${getUserAnswerText(activityData, userAnswer)}</p>
                                    <p class="mb-0 text-success"><strong>Respuesta correcta:</strong> ${getCorrectAnswerText(activityData, questionIndex)}</p>
                                </div>
                            </div>
                        `;
                    }
                });

                feedbackHtml += '</div>';
            }

            // Mostrar el feedback
            const feedbackContainer = document.getElementById(`activity-feedback-${sectionId}`);
            feedbackContainer.innerHTML = feedbackHtml;
            feedbackContainer.style.display = 'block';

            // Hacer scroll al feedback
            feedbackContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        /**
         * Obtiene el texto de la respuesta correcta
         */
        function getCorrectAnswerText(activityData, questionIndex) {
            const question = activityData.questions[questionIndex];

            if (activityData.type === 'multiple-choice') {
                if (question.options && Array.isArray(question.options) &&
                    question.correctAnswer !== undefined &&
                    question.options[question.correctAnswer]) {
                    return question.options[question.correctAnswer];
                }
                return 'No disponible';
            } else if (activityData.type === 'true-false') {
                return question.correctAnswer === true || question.correctAnswer === 'true' ? 'Verdadero' : 'Falso';
            } else if (activityData.type === 'short-answer') {
                return question.correctAnswer || 'No disponible';
            }

            return 'No disponible';
        }

        /**
         * Obtiene el texto de la respuesta del usuario
         */
        function getUserAnswerText(activityData, userAnswer) {
            const questionIndex = userAnswer.questionIndex;
            const question = activityData.questions[questionIndex];

            if (activityData.type === 'multiple-choice') {
                if (question.options && Array.isArray(question.options) &&
                    userAnswer.answer !== undefined &&
                    question.options[userAnswer.answer]) {
                    return question.options[userAnswer.answer];
                }
                return 'No seleccionada';
            } else if (activityData.type === 'true-false') {
                return userAnswer.answer === 'true' ? 'Verdadero' : 'Falso';
            } else if (activityData.type === 'short-answer') {
                return userAnswer.answer || 'No respondida';
            }

            return 'No disponible';
        }

        /**
         * Muestra feedback para una actividad
         */
        function showActivityFeedback(sectionId, type, message) {
            const feedbackContainer = document.getElementById(`activity-feedback-${sectionId}`);

            let alertClass = 'alert-info';
            if (type === 'success') alertClass = 'alert-success';
            else if (type === 'warning') alertClass = 'alert-warning';
            else if (type === 'error') alertClass = 'alert-danger';

            feedbackContainer.innerHTML = `
                <div class="alert ${alertClass}">
                    <i class="fas fa-info-circle me-2"></i>
                    ${message}
                </div>
            `;

            feedbackContainer.style.display = 'block';
            feedbackContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    </script>
</body>
</html>