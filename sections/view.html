<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sección - MatemáticaWeb</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/section-editor.css">
</head>
<body>
    <div id="header"></div>

    <main class="container mt-4">
        <div id="sectionContent">
            <nav aria-label="breadcrumb" class="mb-4">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="../index.html">Inicio</a></li>
                    <li class="breadcrumb-item"><a href="#" id="courseLink">Curso</a></li>
                    <li class="breadcrumb-item active" id="sectionTitle">Sección</li>
                </ol>
            </nav>

            <div class="row">
                <div class="col-md-8">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2 id="sectionTitleHeader">Cargando...</h2>
                        <div class="navigation-buttons">
                            <a href="#" id="backToCourseBtn" class="btn btn-outline-primary me-2">
                                <i class="fas fa-arrow-left"></i> Volver al curso
                            </a>
                            <a href="../index.html" class="btn btn-outline-secondary">
                                <i class="fas fa-home"></i> Inicio
                            </a>
                        </div>
                    </div>
                    <div class="section-preview" id="sectionPreview">
                        <div class="text-center py-5">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <p class="mt-3">Cargando contenido...</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="topic-sidebar">
                        <div class="topic-info">
                            <h4>Información del Tema</h4>
                            <div id="topicInfo">
                                <p class="text-muted">Cargando información del tema...</p>
                            </div>
                        </div>

                        <div class="other-sections mt-4">
                            <h4>Otras Secciones</h4>
                            <div id="otherSections">
                                <p class="text-muted">Cargando secciones...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="footer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/sample-data.js"></script>
    <script src="../js/data-persistence.js"></script>
    <script src="../js/data-manager.js"></script>
    <script src="../js/main.js"></script>
    <script>
        // Variables globales
        let currentSectionId = null;
        let currentTopicId = null;
        let currentSection = null;
        let currentTopic = null;

        document.addEventListener('DOMContentLoaded', async () => {
            loadComponent('header', '../components/header.html');
            loadComponent('footer', '../components/footer.html');

            // Inicializar sistema de persistencia antes de cargar los datos
            if (typeof initializeDataSystem === 'function') {
                console.log('Inicializando sistema de persistencia en sections/view.html...');
                await initializeDataSystem();
            }

            // Obtener los IDs de la URL
            const urlParams = new URLSearchParams(window.location.search);

            // Obtener los parámetros sin convertir a entero primero
            const sectionIdParam = urlParams.get('id');
            const topicIdParam = urlParams.get('topicId');

            console.log('Parámetros de URL originales:', { sectionIdParam, topicIdParam });

            // Intentar convertir a entero si es posible, pero mantener el valor original si falla
            currentSectionId = !isNaN(parseInt(sectionIdParam)) ? parseInt(sectionIdParam) : sectionIdParam;
            currentTopicId = !isNaN(parseInt(topicIdParam)) ? parseInt(topicIdParam) : topicIdParam;

            console.log('Parámetros de URL procesados:', { currentSectionId, currentTopicId });

            if (!currentSectionId || !currentTopicId) {
                showError('Parámetros incorrectos', 'No se pudo cargar la sección porque faltan parámetros.');
                return;
            }

            // Esperar un momento para asegurar que todos los componentes estén cargados
            setTimeout(() => {
                // Cargar los datos
                loadData();
            }, 100);
        });

        function loadData() {
            try {
                console.log('Cargando datos para tema ID:', currentTopicId, 'y sección ID:', currentSectionId);
                console.log('Tipo de currentSectionId:', typeof currentSectionId);

                // Obtener el tema
                currentTopic = DataManager.getTopicById(currentTopicId);
                console.log('Tema obtenido:', currentTopic);

                if (!currentTopic) {
                    showError('Tema no encontrado', 'El tema solicitado no existe.');
                    return;
                }

                // Obtener la sección
                if (!currentTopic.sections) {
                    console.error('El tema no tiene la propiedad sections:', currentTopic);
                    showError('Sección no encontrada', 'Este tema no tiene secciones.');
                    return;
                }

                console.log('Secciones del tema:', currentTopic.sections);

                // Intentar encontrar la sección por ID (considerando que puede ser string o número)
                currentSection = currentTopic.sections.find(s => {
                    // Convertir ambos a string para comparación
                    return String(s.id) === String(currentSectionId);
                });

                console.log('Sección encontrada:', currentSection);

                if (!currentSection) {
                    showError('Sección no encontrada', 'La sección solicitada no existe.');
                    return;
                }

                // Obtener el curso
                const course = DataManager.getCourseById(currentTopic.courseId);
                console.log('Curso obtenido:', course);

                if (!course) {
                    showError('Curso no encontrado', 'El curso asociado no existe.');
                    return;
                }

                // Actualizar la navegación
                document.title = `${currentSection.title} - MatemáticaWeb`;
                document.getElementById('sectionTitle').textContent = currentSection.title;
                document.getElementById('sectionTitleHeader').textContent = currentSection.title;

                const courseLink = document.getElementById('courseLink');
                courseLink.textContent = course.title;
                courseLink.href = `../courses/view.html?id=${course.id}`;

                // Configurar el botón para volver al curso
                const backToCourseBtn = document.getElementById('backToCourseBtn');
                backToCourseBtn.href = `../courses/view.html?id=${course.id}`;

                // Mostrar información del tema
                document.getElementById('topicInfo').innerHTML = `
                    <h5>${currentTopic.title}</h5>
                    <p>${currentTopic.description}</p>
                    <a href="../courses/view.html?id=${course.id}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-arrow-left"></i> Volver al curso
                    </a>
                `;

                // Mostrar otras secciones del tema
                const otherSectionsHtml = currentTopic.sections
                    .filter(s => s.id !== currentSectionId)
                    .map(section => `
                        <div class="other-section-item">
                            <a href="view.html?id=${section.id}&topicId=${currentTopicId}" class="other-section-link">
                                <i class="${getSectionIcon(section.type)}"></i>
                                ${section.title}
                            </a>
                        </div>
                    `).join('');

                document.getElementById('otherSections').innerHTML = otherSectionsHtml ||
                    '<p class="text-muted">No hay más secciones en este tema.</p>';

                console.log('Preparando para renderizar la sección:', currentSection);
                console.log('Tipo de sección:', currentSection.type);
                console.log('Contenido de la sección:', currentSection.content);
                console.log('ID de la sección:', currentSection.id, 'Tipo:', typeof currentSection.id);

                // Verificar si la sección tiene un tipo válido
                if (!currentSection.type) {
                    console.error('La sección no tiene un tipo definido');
                    showError('Error de configuración', 'La sección no tiene un tipo definido.');
                    return;
                }

                // Verificar si la sección tiene contenido
                if (currentSection.content === undefined || currentSection.content === null) {
                    console.error('La sección no tiene contenido definido');
                    showError('Error de configuración', 'La sección no tiene contenido definido.');
                    return;
                }

                // Mostrar el contenido de la sección
                try {
                    renderSectionContent();
                    console.log('Sección renderizada correctamente');
                } catch (renderError) {
                    console.error('Error al renderizar la sección:', renderError);
                    showError('Error de renderizado', 'Ocurrió un error al mostrar el contenido de la sección.');
                }
            } catch (error) {
                console.error('Error al cargar los datos:', error);
                showError('Error', 'Ocurrió un error al cargar el contenido.');
            }
        }

        function renderSectionContent() {
            const sectionPreview = document.getElementById('sectionPreview');

            // Limpiar el contenedor de la sección
            sectionPreview.innerHTML = '';

            // Crear el encabezado de la sección
            const headerDiv = document.createElement('div');
            headerDiv.className = 'section-preview-header';

            const iconDiv = document.createElement('div');
            iconDiv.className = 'section-preview-icon';

            const icon = document.createElement('i');
            icon.className = getSectionIcon(currentSection.type);
            iconDiv.appendChild(icon);

            const title = document.createElement('h2');
            title.className = 'section-preview-title';
            title.textContent = currentSection.title;

            headerDiv.appendChild(iconDiv);
            headerDiv.appendChild(title);

            // Añadir el encabezado al contenedor
            sectionPreview.appendChild(headerDiv);

            // Crear el contenedor principal para el contenido
            const sectionPreviewContent = document.createElement('div');
            sectionPreviewContent.className = 'section-preview-content';

            switch (currentSection.type) {
                case 'text':
                    sectionPreviewContent.classList.add('text-content');
                    sectionPreviewContent.innerHTML = currentSection.content;
                    sectionPreview.appendChild(sectionPreviewContent);
                    break;

                case 'youtube':
                    const youtubeContainer = document.createElement('div');
                    youtubeContainer.className = 'youtube-container';

                    const youtubeIframe = document.createElement('iframe');
                    youtubeIframe.src = `https://www.youtube.com/embed/${currentSection.content}`;
                    youtubeIframe.frameBorder = '0';
                    youtubeIframe.allowFullscreen = true;
                    youtubeIframe.style.width = '100%';
                    youtubeIframe.style.height = '400px';

                    youtubeContainer.appendChild(youtubeIframe);
                    sectionPreviewContent.appendChild(youtubeContainer);
                    sectionPreview.appendChild(sectionPreviewContent);
                    break;

                case 'geogebra':
                    const geogebraContainer = document.createElement('div');
                    geogebraContainer.className = 'geogebra-container';

                    const geogebraIframe = document.createElement('iframe');
                    geogebraIframe.src = `https://www.geogebra.org/material/iframe/id/${currentSection.content}`;
                    geogebraIframe.frameBorder = '0';
                    geogebraIframe.style.width = '100%';
                    geogebraIframe.style.height = '500px';

                    geogebraContainer.appendChild(geogebraIframe);
                    sectionPreviewContent.appendChild(geogebraContainer);
                    sectionPreview.appendChild(sectionPreviewContent);
                    break;

                case 'image':
                    const imageContainer = document.createElement('div');
                    imageContainer.className = 'image-container';

                    const image = document.createElement('img');
                    image.src = currentSection.content;
                    image.alt = currentSection.title;

                    imageContainer.appendChild(image);
                    sectionPreviewContent.appendChild(imageContainer);
                    sectionPreview.appendChild(sectionPreviewContent);
                    break;

                case 'pdf':
                    const pdfContainer = document.createElement('div');
                    pdfContainer.className = 'pdf-container';

                    const pdfLink = document.createElement('a');
                    pdfLink.href = currentSection.content;
                    pdfLink.target = '_blank';
                    pdfLink.download = '';

                    const pdfIcon = document.createElement('i');
                    pdfIcon.className = 'fas fa-file-pdf';
                    pdfLink.appendChild(pdfIcon);
                    pdfLink.appendChild(document.createTextNode(' Descargar PDF'));

                    pdfContainer.appendChild(pdfLink);
                    sectionPreviewContent.appendChild(pdfContainer);
                    sectionPreview.appendChild(sectionPreviewContent);
                    break;

                case 'html':
                    // Determinar las rutas correctas basadas en el entorno
                    let htmlPath, fallbackHtmlPath;

                    // Determinar si estamos en producción (Netlify) o desarrollo local
                    const isProduction = window.location.hostname.includes('netlify.app') ||
                                       window.location.hostname.includes('netlify.com');

                    if (isProduction) {
                        // En producción (Netlify), usar rutas absolutas
                        htmlPath = '/activities/html/' + currentSection.content;
                        fallbackHtmlPath = '/activities/html/ejemplo-simple.html';
                    } else {
                        // En desarrollo local, usar rutas relativas
                        htmlPath = '../activities/html/' + currentSection.content;
                        fallbackHtmlPath = '../activities/html/ejemplo-simple.html';
                    }

                    console.log('Entorno:', isProduction ? 'Producción (Netlify)' : 'Desarrollo local');
                    console.log('Cargando HTML desde:', htmlPath);
                    console.log('Fallback HTML:', fallbackHtmlPath);

                    // Crear el iframe sin script inline
                    const iframeHtml = document.createElement('iframe');
                    iframeHtml.frameBorder = '0';
                    iframeHtml.style.width = '100%';
                    iframeHtml.style.height = '500px';
                    iframeHtml.style.border = '1px solid #ddd';
                    iframeHtml.style.borderRadius = '4px';
                    iframeHtml.setAttribute('allowfullscreen', 'true');
                    iframeHtml.setAttribute('loading', 'lazy');

                    // Establecer la fuente después de crear el elemento
                    iframeHtml.src = htmlPath;

                    // Crear el contenedor HTML
                    const htmlContainer = document.createElement('div');
                    htmlContainer.className = 'html-container';
                    htmlContainer.appendChild(iframeHtml);

                    // Añadir el contenedor HTML al contenedor principal
                    sectionPreviewContent.appendChild(htmlContainer);
                    sectionPreview.appendChild(sectionPreviewContent);

                    // Verificar si el archivo existe
                    fetch(htmlPath)
                        .then(response => {
                            console.log('Respuesta de fetch HTML:', response);
                            if (!response.ok) {
                                console.warn('Archivo ' + htmlPath + ' no encontrado, usando fallback');
                                iframeHtml.src = fallbackHtmlPath;
                            } else {
                                console.log('Archivo HTML encontrado correctamente');
                            }
                        })
                        .catch(error => {
                            console.error('Error verificando archivo ' + htmlPath + ':', error);
                            iframeHtml.src = fallbackHtmlPath;
                        });
                    break;

                case 'activity':
                    // Determinar las rutas correctas basadas en el entorno
                    let activityPath, fallbackActivityPath;

                    // Determinar si estamos en producción (Netlify) o desarrollo local
                    const isProductionActivity = window.location.hostname.includes('netlify.app') ||
                                               window.location.hostname.includes('netlify.com');

                    if (isProductionActivity) {
                        // En producción (Netlify), usar rutas absolutas
                        activityPath = '/activities/templates/' + currentSection.content;
                        fallbackActivityPath = '/activities/templates/ejemplo-simple.html';
                    } else {
                        // En desarrollo local, usar rutas relativas
                        activityPath = '../activities/templates/' + currentSection.content;
                        fallbackActivityPath = '../activities/templates/ejemplo-simple.html';
                    }

                    console.log('Entorno:', isProductionActivity ? 'Producción (Netlify)' : 'Desarrollo local');
                    console.log('Cargando Activity desde:', activityPath);
                    console.log('Fallback Activity:', fallbackActivityPath);

                    // Crear el iframe sin script inline
                    const iframeActivity = document.createElement('iframe');
                    iframeActivity.frameBorder = '0';
                    iframeActivity.style.width = '100%';
                    iframeActivity.style.height = '600px';
                    iframeActivity.style.border = '1px solid #ddd';
                    iframeActivity.style.borderRadius = '4px';
                    iframeActivity.setAttribute('allowfullscreen', 'true');
                    iframeActivity.setAttribute('loading', 'lazy');

                    // Establecer la fuente después de crear el elemento
                    iframeActivity.src = activityPath;

                    // Crear el contenedor de actividad
                    const activityContainer = document.createElement('div');
                    activityContainer.className = 'activity-container';
                    activityContainer.appendChild(iframeActivity);

                    // Añadir el contenedor de actividad al contenedor principal
                    sectionPreviewContent.appendChild(activityContainer);
                    sectionPreview.appendChild(sectionPreviewContent);

                    // Verificar si el archivo existe
                    fetch(activityPath)
                        .then(response => {
                            console.log('Respuesta de fetch Activity:', response);
                            if (!response.ok) {
                                console.warn('Archivo ' + activityPath + ' no encontrado, usando fallback');
                                iframeActivity.src = fallbackActivityPath;
                            } else {
                                console.log('Archivo Activity encontrado correctamente');
                            }
                        })
                        .catch(error => {
                            console.error('Error verificando archivo ' + activityPath + ':', error);
                            iframeActivity.src = fallbackActivityPath;
                        });
                    break;

                default:
                    const unsupportedText = document.createElement('p');
                    unsupportedText.className = 'text-muted';
                    unsupportedText.textContent = 'Tipo de contenido no soportado: ' + currentSection.type;

                    sectionPreviewContent.appendChild(unsupportedText);
                    sectionPreview.appendChild(sectionPreviewContent);
            }
        }

        function showError(title, message) {
            document.getElementById('sectionPreview').innerHTML = `
                <div class="alert alert-danger">
                    <h4>${title}</h4>
                    <p>${message}</p>
                    <a href="../index.html" class="btn btn-outline-primary mt-3">
                        <i class="fas fa-home"></i> Volver al inicio
                    </a>
                </div>
            `;

            document.getElementById('topicInfo').innerHTML = `
                <p class="text-muted">Información no disponible</p>
            `;

            document.getElementById('otherSections').innerHTML = `
                <p class="text-muted">Información no disponible</p>
            `;
        }

        function getSectionIcon(type) {
            if (!type) {
                console.warn('Tipo de sección no definido, usando icono por defecto');
                return 'fas fa-file';
            }

            switch (type) {
                case 'text':
                    return 'fas fa-align-left';
                case 'youtube':
                    return 'fab fa-youtube';
                case 'geogebra':
                    return 'fas fa-calculator';
                case 'image':
                    return 'fas fa-image';
                case 'pdf':
                    return 'fas fa-file-pdf';
                case 'html':
                    return 'fas fa-code';
                case 'activity':
                    return 'fas fa-tasks';
                default:
                    console.warn('Tipo de sección desconocido:', type);
                    return 'fas fa-file';
            }
        }
    </script>
</body>
</html>
