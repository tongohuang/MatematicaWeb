<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tema - MatemáticaWeb</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/section-editor.css">
    <script src="../js/netlify-debug.js"></script>
    <script src="../js/content-loader.js"></script>
    <script src="../js/error-handler.js"></script>
    <script src="../js/polyfill.min.js"></script>
    <script src="../js/netlify-activity-handler.js"></script>
</head>
<body>
    <div id="header"></div>

    <main class="container mt-4">
        <div id="topicContent">
            <nav aria-label="breadcrumb" class="mb-4">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="../index.html">Inicio</a></li>
                    <li class="breadcrumb-item"><a href="#" id="courseLink">Curso</a></li>
                    <li class="breadcrumb-item active" id="topicTitle">Tema</li>
                </ol>
            </nav>

            <div class="row">
                <div class="col-md-8">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h1 id="topicTitleHeader">Cargando...</h1>
                        <div class="navigation-buttons">
                            <a href="#" id="backToCourseBtn" class="btn btn-outline-primary me-2">
                                <i class="fas fa-arrow-left"></i> Volver al curso
                            </a>
                            <a href="../index.html" class="btn btn-outline-secondary">
                                <i class="fas fa-home"></i> Inicio
                            </a>
                        </div>
                    </div>

                    <div class="section-controls mb-4">
                        <button id="expandAllBtn" class="btn btn-sm btn-outline-primary me-2">
                            <i class="fas fa-expand-alt"></i> Expandir todo
                        </button>
                        <button id="collapseAllBtn" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-compress-alt"></i> Colapsar todo
                        </button>
                    </div>

                    <div class="topic-description mb-4" id="topicDescription">
                        <p class="lead">Cargando descripción...</p>
                    </div>

                    <div class="sections-container" id="sectionsContainer">
                        <div class="text-center py-5">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <p class="mt-3">Cargando secciones...</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="topic-sidebar">
                        <div class="course-info">
                            <h4>Información del Curso</h4>
                            <div id="courseInfo">
                                <p class="text-muted">Cargando información del curso...</p>
                            </div>
                        </div>

                        <div class="topic-navigation mt-4">
                            <h4>Temas del Curso</h4>
                            <div id="topicsNavigation">
                                <p class="text-muted">Cargando temas...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="footer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/sample-data.js"></script>
    <script src="../js/data-persistence.js"></script>
    <script src="../js/data-manager.js"></script>
    <script src="../js/main.js"></script>
    <script>
        // Variables globales
        let currentTopicId = null;
        let currentCourseId = null;
        let currentTopic = null;

        /**
         * Renderiza una actividad directamente en el contenedor especificado
         * @param {Object} activityData - Datos de la actividad
         * @param {HTMLElement} container - Contenedor donde se mostrará la actividad
         */
        function renderActivity(activityData, container) {
            console.log('Renderizando actividad:', activityData.id);

            // Verificar que tengamos datos válidos
            if (!activityData || !container) {
                console.error('Datos de actividad o contenedor no válidos');
                return;
            }

            // Crear el contenedor para la actividad
            container.innerHTML = `
                <div class="activity-content p-4">
                    <h3 class="mb-3">${activityData.title || 'Actividad'}</h3>
                    <div id="activity-questions-${activityData.id}" class="mb-4"></div>
                    <div id="activity-feedback-${activityData.id}" class="alert d-none mb-3"></div>
                    <div class="d-flex justify-content-between">
                        <button id="activity-check-${activityData.id}" class="btn btn-primary">
                            <i class="fas fa-check-circle me-2"></i> Verificar respuestas
                        </button>
                        <button id="activity-reset-${activityData.id}" class="btn btn-outline-secondary">
                            <i class="fas fa-redo me-2"></i> Reiniciar
                        </button>
                    </div>
                </div>
            `;

            // Renderizar las preguntas de la actividad
            const questionsContainer = document.getElementById(`activity-questions-${activityData.id}`);
            if (questionsContainer) {
                // Si no hay preguntas, mostrar un mensaje
                if (!activityData.questions || activityData.questions.length === 0) {
                    questionsContainer.innerHTML = `
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Esta actividad aún no tiene preguntas configuradas.
                        </div>
                    `;
                } else {
                    // Renderizar cada pregunta
                    activityData.questions.forEach((question, index) => {
                        const questionHtml = renderQuestion(question, index, activityData.id);
                        questionsContainer.innerHTML += questionHtml;
                    });
                }
            }

            // Configurar eventos para los botones
            setTimeout(() => {
                const checkButton = document.getElementById(`activity-check-${activityData.id}`);
                const resetButton = document.getElementById(`activity-reset-${activityData.id}`);

                if (checkButton) {
                    checkButton.addEventListener('click', () => checkActivityAnswers(activityData));
                }

                if (resetButton) {
                    resetButton.addEventListener('click', () => resetActivity(activityData, container));
                }
            }, 100);
        }

        /**
         * Renderiza una pregunta de la actividad
         * @param {Object} question - Datos de la pregunta
         * @param {number} index - Índice de la pregunta
         * @param {string} activityId - ID de la actividad
         * @returns {string} HTML de la pregunta
         */
        function renderQuestion(question, index, activityId) {
            const questionNumber = index + 1;
            const questionId = `question-${activityId}-${index}`;

            let questionHtml = `
                <div class="card mb-3 question-card" data-question-index="${index}">
                    <div class="card-header bg-light">
                        <strong>Pregunta ${questionNumber}</strong>
                    </div>
                    <div class="card-body">
                        <p class="card-text">${question.text || 'Sin texto'}</p>
            `;

            // Renderizar diferentes tipos de preguntas
            switch (question.type) {
                case 'multiple_choice':
                    questionHtml += renderMultipleChoiceQuestion(question, questionId);
                    break;

                case 'true_false':
                    questionHtml += renderTrueFalseQuestion(question, questionId);
                    break;

                case 'short_answer':
                    questionHtml += renderShortAnswerQuestion(question, questionId);
                    break;

                default:
                    questionHtml += `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Tipo de pregunta no soportado: ${question.type || 'no especificado'}
                        </div>
                    `;
            }

            questionHtml += `
                    </div>
                </div>
            `;

            return questionHtml;
        }

        /**
         * Renderiza una pregunta de opción múltiple
         * @param {Object} question - Datos de la pregunta
         * @param {string} questionId - ID de la pregunta
         * @returns {string} HTML de la pregunta
         */
        function renderMultipleChoiceQuestion(question, questionId) {
            let optionsHtml = '<div class="mt-3">';

            if (question.options && question.options.length > 0) {
                question.options.forEach((option, optionIndex) => {
                    const optionId = `${questionId}-option-${optionIndex}`;
                    optionsHtml += `
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="${questionId}" id="${optionId}" value="${optionIndex}">
                            <label class="form-check-label" for="${optionId}">
                                ${option.text || 'Opción sin texto'}
                            </label>
                        </div>
                    `;
                });
            } else {
                optionsHtml += `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Esta pregunta no tiene opciones configuradas.
                    </div>
                `;
            }

            optionsHtml += '</div>';
            return optionsHtml;
        }

        /**
         * Renderiza una pregunta de verdadero/falso
         * @param {Object} question - Datos de la pregunta
         * @param {string} questionId - ID de la pregunta
         * @returns {string} HTML de la pregunta
         */
        function renderTrueFalseQuestion(question, questionId) {
            return `
                <div class="mt-3">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="${questionId}" id="${questionId}-true" value="true">
                        <label class="form-check-label" for="${questionId}-true">
                            Verdadero
                        </label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="${questionId}" id="${questionId}-false" value="false">
                        <label class="form-check-label" for="${questionId}-false">
                            Falso
                        </label>
                    </div>
                </div>
            `;
        }

        /**
         * Renderiza una pregunta de respuesta corta
         * @param {Object} question - Datos de la pregunta
         * @param {string} questionId - ID de la pregunta
         * @returns {string} HTML de la pregunta
         */
        function renderShortAnswerQuestion(question, questionId) {
            return `
                <div class="mt-3">
                    <div class="form-group">
                        <input type="text" class="form-control" id="${questionId}-input" placeholder="Escribe tu respuesta aquí...">
                    </div>
                </div>
            `;
        }

        /**
         * Verifica las respuestas de la actividad
         * @param {Object} activityData - Datos de la actividad
         */
        function checkActivityAnswers(activityData) {
            console.log('Verificando respuestas para actividad:', activityData.id);

            // Verificar que tengamos preguntas
            if (!activityData.questions || activityData.questions.length === 0) {
                showActivityFeedback(activityData.id, 'warning', 'Esta actividad no tiene preguntas configuradas.');
                return;
            }

            let correctAnswers = 0;
            let totalQuestions = activityData.questions.length;

            // Verificar cada pregunta
            activityData.questions.forEach((question, index) => {
                const questionId = `question-${activityData.id}-${index}`;
                let userAnswer = null;
                let isCorrect = false;

                // Obtener la respuesta del usuario según el tipo de pregunta
                switch (question.type) {
                    case 'multiple_choice':
                        const selectedOption = document.querySelector(`input[name="${questionId}"]:checked`);
                        if (selectedOption) {
                            userAnswer = parseInt(selectedOption.value);
                            isCorrect = userAnswer === question.correctOption;
                        }
                        break;

                    case 'true_false':
                        const selectedValue = document.querySelector(`input[name="${questionId}"]:checked`);
                        if (selectedValue) {
                            userAnswer = selectedValue.value === 'true';
                            isCorrect = userAnswer === question.correctAnswer;
                        }
                        break;

                    case 'short_answer':
                        const inputElement = document.getElementById(`${questionId}-input`);
                        if (inputElement) {
                            userAnswer = inputElement.value.trim().toLowerCase();
                            // Para respuestas cortas, verificar si la respuesta está en la lista de respuestas correctas
                            if (question.correctAnswers && Array.isArray(question.correctAnswers)) {
                                isCorrect = question.correctAnswers.some(answer =>
                                    userAnswer === answer.trim().toLowerCase());
                            }
                        }
                        break;
                }

                // Marcar la pregunta como correcta o incorrecta
                const questionCard = document.querySelector(`.question-card[data-question-index="${index}"]`);
                if (questionCard) {
                    if (userAnswer !== null) {
                        if (isCorrect) {
                            questionCard.classList.add('border-success');
                            questionCard.classList.remove('border-danger');
                            correctAnswers++;
                        } else {
                            questionCard.classList.add('border-danger');
                            questionCard.classList.remove('border-success');
                        }
                    } else {
                        questionCard.classList.add('border-warning');
                        questionCard.classList.remove('border-success', 'border-danger');
                    }
                }
            });

            // Mostrar retroalimentación general
            const percentage = Math.round((correctAnswers / totalQuestions) * 100);
            let feedbackType = 'info';
            let feedbackMessage = '';

            if (correctAnswers === totalQuestions) {
                feedbackType = 'success';
                feedbackMessage = '¡Excelente! Todas las respuestas son correctas.';
            } else if (percentage >= 70) {
                feedbackType = 'success';
                feedbackMessage = `Buen trabajo. Has respondido correctamente ${correctAnswers} de ${totalQuestions} preguntas (${percentage}%).`;
            } else if (percentage >= 40) {
                feedbackType = 'warning';
                feedbackMessage = `Has respondido correctamente ${correctAnswers} de ${totalQuestions} preguntas (${percentage}%). Puedes mejorar.`;
            } else {
                feedbackType = 'danger';
                feedbackMessage = `Has respondido correctamente ${correctAnswers} de ${totalQuestions} preguntas (${percentage}%). Revisa el material nuevamente.`;
            }

            showActivityFeedback(activityData.id, feedbackType, feedbackMessage);
        }

        /**
         * Muestra retroalimentación para la actividad
         * @param {string} activityId - ID de la actividad
         * @param {string} type - Tipo de retroalimentación (success, warning, danger, info)
         * @param {string} message - Mensaje de retroalimentación
         */
        function showActivityFeedback(activityId, type, message) {
            const feedbackElement = document.getElementById(`activity-feedback-${activityId}`);
            if (feedbackElement) {
                feedbackElement.className = `alert alert-${type} mb-3`;
                feedbackElement.innerHTML = message;
                feedbackElement.classList.remove('d-none');
            }
        }

        /**
         * Reinicia la actividad
         * @param {Object} activityData - Datos de la actividad
         * @param {HTMLElement} container - Contenedor de la actividad
         */
        function resetActivity(activityData, container) {
            console.log('Reiniciando actividad:', activityData.id);
            renderActivity(activityData, container);
        }

        // Variable para el curso actual
        let currentCourse = null;

        document.addEventListener('DOMContentLoaded', async () => {
            loadComponent('header', '../components/header.html');
            loadComponent('footer', '../components/footer.html');

            // Inicializar sistema de persistencia antes de cargar los datos
            if (typeof initializeDataSystem === 'function') {
                console.log('Inicializando sistema de persistencia en topics/view.html...');
                await initializeDataSystem();
            }

            // Obtener los IDs de la URL
            const urlParams = new URLSearchParams(window.location.search);
            currentTopicId = parseInt(urlParams.get('id'));
            currentCourseId = parseInt(urlParams.get('courseId'));

            if (!currentTopicId || !currentCourseId) {
                showError('Parámetros incorrectos', 'No se pudo cargar el tema porque faltan parámetros.');
                return;
            }

            // Cargar los datos
            loadData();
        });

        function loadData() {
            try {
                // Obtener el curso
                currentCourse = DataManager.getCourseById(currentCourseId);
                if (!currentCourse) {
                    showError('Curso no encontrado', 'El curso solicitado no existe.');
                    return;
                }

                // Obtener el tema
                currentTopic = DataManager.getTopicById(currentTopicId);
                if (!currentTopic) {
                    showError('Tema no encontrado', 'El tema solicitado no existe.');
                    return;
                }

                // Actualizar la navegación
                document.title = `${currentTopic.title} - MatemáticaWeb`;
                document.getElementById('topicTitle').textContent = currentTopic.title;
                document.getElementById('topicTitleHeader').textContent = currentTopic.title;
                document.getElementById('topicDescription').innerHTML = `<p class="lead">${currentTopic.description}</p>`;

                const courseLink = document.getElementById('courseLink');
                courseLink.textContent = currentCourse.title;
                courseLink.href = `../courses/view.html?id=${currentCourse.id}`;

                // Configurar el botón para volver al curso
                const backToCourseBtn = document.getElementById('backToCourseBtn');
                backToCourseBtn.href = `../courses/view.html?id=${currentCourse.id}`;

                // Mostrar información del curso
                document.getElementById('courseInfo').innerHTML = `
                    <div class="course-info-card">
                        <div class="course-info-icon" style="background-color: ${currentCourse.color || '#6c757d'}">
                            <i class="${currentCourse.icon || 'fas fa-book'}"></i>
                        </div>
                        <div class="course-info-content">
                            <h5>${currentCourse.title}</h5>
                            <p class="small">${currentCourse.description}</p>
                            <a href="../courses/view.html?id=${currentCourse.id}" class="btn btn-sm btn-outline-primary">
                                Ver todos los temas
                            </a>
                        </div>
                    </div>
                `;

                // Mostrar navegación de temas
                loadTopicsNavigation();

                // Cargar las secciones del tema
                loadSections();
            } catch (error) {
                console.error('Error al cargar los datos:', error);
                showError('Error', 'Ocurrió un error al cargar el contenido.');
            }
        }

        function loadTopicsNavigation() {
            // Obtener todos los temas del curso
            const topics = DataManager.getTopicsByCourse(currentCourseId);

            if (topics.length === 0) {
                document.getElementById('topicsNavigation').innerHTML = '<p class="text-muted">Este curso no tiene temas.</p>';
                return;
            }

            // Crear la lista de temas
            const topicsHtml = topics.map(topic => {
                const isActive = topic.id === currentTopicId;
                return `
                    <div class="topic-nav-item ${isActive ? 'active' : ''}">
                        <a href="view.html?id=${topic.id}&courseId=${currentCourseId}" class="topic-nav-link">
                            <div class="topic-nav-icon">
                                <i class="${topic.icon || 'fas fa-book'}"></i>
                            </div>
                            <div class="topic-nav-title">${topic.title}</div>
                        </a>
                    </div>
                `;
            }).join('');

            document.getElementById('topicsNavigation').innerHTML = topicsHtml;
        }

        function loadSections() {
            console.log('Cargando secciones para el tema:', currentTopic.title);
            const sectionsContainer = document.getElementById('sectionsContainer');

            // Obtener secciones del tema y del sistema de persistencia
            let sections = [];

            // Primero intentar obtener las secciones del tema
            if (currentTopic.sections && Array.isArray(currentTopic.sections) && currentTopic.sections.length > 0) {
                sections = [...currentTopic.sections];
                console.log(`Encontradas ${sections.length} secciones en el tema`);
            }

            // Si no hay secciones en el tema o son pocas, intentar obtenerlas del sistema de persistencia
            if (sections.length === 0 && typeof DataPersistence !== 'undefined') {
                console.log('Buscando secciones en el sistema de persistencia...');
                const allSections = DataPersistence.getAllDataAsArray('sections');

                // Filtrar secciones que pertenezcan al tema actual
                const persistenceSections = allSections.filter(s => s.topicId == currentTopicId);
                console.log(`Encontradas ${persistenceSections.length} secciones en el sistema de persistencia`);

                if (persistenceSections.length > 0) {
                    sections = persistenceSections;
                }
            }

            // Asignar las secciones al tema actual para procesamiento posterior
            currentTopic.sections = sections;

            // Verificar si el tema tiene secciones
            if (!currentTopic.sections || currentTopic.sections.length === 0) {
                sectionsContainer.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Este tema aún no tiene secciones.
                    </div>
                `;
                return;
            }

            // Crear el contenido para cada sección
            let sectionsHtml = '';
            let sectionCounter = 1;

            // Objeto para agrupar las secciones por su groupId
            const groupedSections = {};

            // Primero identificar todos los grupos
            currentTopic.sections.forEach(section => {
                if (section.groupId) {
                    // Si la sección pertenece a un grupo
                    if (!groupedSections[section.groupId]) {
                        groupedSections[section.groupId] = {
                            name: section.groupName || 'Grupo sin nombre',
                            sections: []
                        };
                    }
                    groupedSections[section.groupId].sections.push(section);
                }
            });

            // Ahora procesar todas las secciones
            currentTopic.sections.forEach((section, index) => {
                // Si la sección ya está procesada como parte de un grupo, la saltamos
                if (section.groupId && section._processed) return;

                if (section.groupId && groupedSections[section.groupId]) {
                    // Es parte de un grupo, mostrar el grupo
                    const group = groupedSections[section.groupId];

                    // Crear el encabezado del grupo
                    sectionsHtml += `
                        <div class="section-block section-group" id="section-group-${section.groupId}">
                            <div class="section-header" role="button" onclick="toggleSection('group-${section.groupId}')">
                                <div class="section-number">${sectionCounter++}</div>
                                <h2 class="section-title">${group.name}</h2>
                                <div class="section-controls">
                                    <div class="section-type-badge">
                                        <i class="fas fa-layer-group"></i> Grupo
                                    </div>
                                    <button class="btn btn-sm btn-link section-toggle" aria-label="Expandir/Colapsar grupo">
                                        <i class="fas fa-chevron-down" id="toggle-icon-group-${section.groupId}"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="section-content" id="section-content-group-${section.groupId}" style="display: none;">
                    `;

                    // Agregar el contenido de todas las secciones del grupo
                    group.sections.forEach(groupSection => {
                        sectionsHtml += renderSectionContent(groupSection);
                        // Marcar la sección como procesada
                        groupSection._processed = true;
                    });

                    // Cerrar el div del grupo
                    sectionsHtml += `
                            </div>
                        </div>
                    `;
                } else {
                    // Sección individual normal
                    sectionsHtml += `
                        <div class="section-block" id="section-${section.id}">
                            <div class="section-header" role="button" onclick="toggleSection(${section.id})">
                                <div class="section-number">${sectionCounter++}</div>
                                <h2 class="section-title">${section.title}</h2>
                                <div class="section-controls">
                                    <div class="section-type-badge">
                                        <i class="${getSectionIcon(section.type).class} ${getSectionIcon(section.type).icon}" style="color: ${getSectionIcon(section.type).color};"></i> ${getTypeName(section.type)}
                                    </div>
                                    <button class="btn btn-sm btn-link section-toggle" aria-label="Expandir/Colapsar sección">
                                        <i class="fas fa-chevron-down" id="toggle-icon-${section.id}"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="section-content" id="section-content-${section.id}" style="display: none;">
                                ${renderSectionContent(section)}
                            </div>
                        </div>
                    `;
                }
            });

            sectionsContainer.innerHTML = sectionsHtml;

            // Configurar los botones de expandir/colapsar todo
            document.getElementById('expandAllBtn').addEventListener('click', expandAllSections);
            document.getElementById('collapseAllBtn').addEventListener('click', collapseAllSections);
        }

        function renderSectionContent(section) {
            console.log('Renderizando contenido para sección:', section.title, 'tipo:', section.type);
            let contentHtml = '';

            switch (section.type) {
                case 'text':
                    contentHtml = `
                        <div class="text-content">
                            ${section.content}
                        </div>
                    `;
                    break;

                case 'youtube':
                    contentHtml = `
                        <div class="youtube-container">
                            <iframe src="https://www.youtube.com/embed/${section.content}"
                                    frameborder="0" allowfullscreen style="width:100%; height:400px;"></iframe>
                        </div>
                    `;
                    break;

                case 'geogebra':
                    contentHtml = `
                        <div class="geogebra-container">
                            <iframe src="https://www.geogebra.org/material/iframe/id/${section.content}"
                                    frameborder="0" style="width:100%; height:500px;"></iframe>
                        </div>
                    `;
                    break;

                case 'image':
                    contentHtml = `
                        <div class="image-container">
                            <img src="${section.content}" alt="${section.title}">
                        </div>
                    `;
                    break;

                case 'pdf':
                    contentHtml = `
                        <div class="pdf-container">
                            <a href="${section.content}" target="_blank" download>
                                <i class="fas fa-file-pdf"></i> Descargar PDF
                            </a>
                        </div>
                    `;
                    break;

                case 'html':
                    // Verificar si el archivo existe
                    // Usar rutas absolutas para Netlify
                    const isNetlifyEnv = window.location.hostname.includes('netlify.app') ||
                                       window.location.hostname.includes('netlify.com');

                    // Construir la ruta base dependiendo del entorno
                    const basePath = isNetlifyEnv ?
                        (window.location.origin + '/activities/html/') :
                        '/activities/html/';

                    const htmlPath = basePath + section.content;
                    const fallbackHtmlPath = basePath + 'ejemplo-simple.html';

                    console.log('Ruta HTML:', htmlPath);
                    console.log('Ruta fallback HTML:', fallbackHtmlPath);

                    // Detectar si estamos en Netlify
                    const isNetlify = window.location.hostname.includes('netlify.app') ||
                                     window.location.hostname.includes('netlify.com');

                    console.log('Cargando HTML en ' + (isNetlify ? 'Netlify' : 'Local') + ': ' + htmlPath);
                    console.log('Tipo de contenido de la sección:', section.type);
                    console.log('Contenido de la sección:', section.content);

                    // En Netlify, usar iframe como antes (ya que el HTML estático funciona bien en Netlify)
                    if (isNetlify) {
                        console.log('Entorno Netlify detectado, cargando HTML con iframe');

                        // Crear un ID único para el contenedor
                        const containerId = `html-container-${section.id}`;

                        // Crear el contenedor para el contenido HTML
                        contentHtml = `
                            <div class="html-container">
                                <div id="${containerId}" class="html-content" style="min-height:300px;"></div>
                            </div>
                        `;

                        // Cargar el contenido HTML usando AJAX en lugar de iframe
                        setTimeout(() => {
                            console.log('Cargando contenido HTML usando AJAX:', htmlPath);
                            loadHTMLContent(htmlPath, containerId, fallbackHtmlPath);
                        }, 100);
                    } else {
                        // En local, usar iframe como antes
                        contentHtml = `
                            <div class="html-container">
                                <iframe src="${htmlPath}" frameborder="0" style="width:100%; height:500px;"
                                        id="html-iframe-${section.id}"></iframe>
                            </div>
                        `;

                        // Verificar si el archivo existe después de cargar
                        setTimeout(() => {
                            const iframe = document.getElementById(`html-iframe-${section.id}`);
                            if (iframe) {
                                fetch(htmlPath, { method: 'HEAD', cache: 'no-store' })
                                    .then(response => {
                                        if (!response.ok) {
                                            console.warn('Archivo ' + htmlPath + ' no encontrado, usando fallback');
                                            iframe.src = fallbackHtmlPath;
                                        }
                                    })
                                    .catch(error => {
                                        console.error('Error verificando archivo ' + htmlPath + ':', error);
                                        iframe.src = fallbackHtmlPath;
                                    });
                            }
                        }, 500);
                    }
                    break;

                case 'activity':
                    console.log('Cargando actividad:', section.content);

                    // Verificar si el contenido es un ID de actividad (activity_TIMESTAMP)
                    if (section.content && section.content.includes('activity_')) {
                        console.log('ID de actividad detectado:', section.content);

                        // Crear un ID único para el contenedor
                        const containerId = `activity-container-${section.id}`;

                        // Crear el contenedor para la actividad
                        contentHtml = `
                            <div class="activity-container">
                                <div id="${containerId}" class="activity-content" style="min-height:400px;">
                                    <div class="text-center p-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Cargando...</span>
                                        </div>
                                        <p class="mt-2">Cargando actividad...</p>
                                    </div>
                                </div>
                            </div>
                        `;

                        // Cargar la actividad desde localStorage
                        setTimeout(() => {
                            // Intentar cargar la actividad desde localStorage
                            let activityData = null;

                            // 1. Intentar con la clave principal
                            const activityDataStr = localStorage.getItem(`activity_data_${section.content}`);

                            // 2. Si no se encuentra, intentar con la clave alternativa
                            if (!activityDataStr) {
                                const alternativeDataStr = localStorage.getItem(section.content);
                                if (alternativeDataStr) {
                                    activityData = JSON.parse(alternativeDataStr);
                                    console.log('Actividad encontrada en localStorage con clave alternativa');
                                }
                            } else {
                                activityData = JSON.parse(activityDataStr);
                                console.log('Actividad encontrada en localStorage con clave principal');
                            }

                            // 3. Si no se encuentra, buscar en el registro de actividades
                            if (!activityData) {
                                try {
                                    const activityRegistry = JSON.parse(localStorage.getItem('activity_registry') || '[]');
                                    const registryEntry = activityRegistry.find(a => a.id === section.content);
                                    if (registryEntry) {
                                        console.log('Actividad encontrada en el registro, creando datos básicos');
                                        // Crear datos básicos para la actividad
                                        activityData = {
                                            id: section.content,
                                            title: registryEntry.title || 'Actividad',
                                            type: registryEntry.type || 'generic',
                                            questions: []
                                        };
                                    }
                                } catch (e) {
                                    console.warn('Error al buscar en el registro de actividades:', e);
                                }
                            }

                            // 4. Si se encontró la actividad, mostrarla
                            if (activityData) {
                                console.log('Actividad encontrada, mostrando directamente');
                                // Mostrar la actividad directamente en la página
                                const activityContainer = document.getElementById(containerId);
                                if (activityContainer) {
                                    // Renderizar la actividad directamente
                                    renderActivity(activityData, activityContainer);
                                }
                            } else {
                                // Si no se encuentra la actividad, mostrar mensaje de error
                                const activityContainer = document.getElementById(containerId);
                                if (activityContainer) {
                                    activityContainer.innerHTML = `
                                        <div class="alert alert-warning">
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            <strong>Actividad no encontrada</strong>
                                            <p>No se pudo cargar la actividad con ID: ${section.content}</p>
                                        </div>
                                    `;
                                }
                            }
                        }, 100);
                    } else {
                        // Si no es un ID de actividad válido, mostrar mensaje de error
                        contentHtml = `
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>ID de actividad no válido</strong>
                                <p>El ID de actividad no tiene el formato correcto: ${section.content || 'No especificado'}</p>
                            </div>
                        `;
                    }
                    break;

                default:
                    contentHtml = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Tipo de contenido no soportado.
                        </div>
                    `;
            }

            return contentHtml;
        }

        function showError(title, message) {
            document.getElementById('sectionsContainer').innerHTML = `
                <div class="alert alert-danger">
                    <h4>${title}</h4>
                    <p>${message}</p>
                    <a href="../index.html" class="btn btn-outline-primary mt-3">
                        <i class="fas fa-home"></i> Volver al inicio
                    </a>
                </div>
            `;

            document.getElementById('courseInfo').innerHTML = `
                <p class="text-muted">Información no disponible</p>
            `;

            document.getElementById('topicsNavigation').innerHTML = `
                <p class="text-muted">Información no disponible</p>
            `;
        }

        // Función para expandir/colapsar una sección
        function toggleSection(sectionId) {
            // Comprobar si es un ID de grupo o de sección individual
            const isGroup = typeof sectionId === 'string' && sectionId.startsWith('group-');
            const contentId = isGroup ? sectionId : sectionId;
            const actualId = isGroup ? sectionId.replace('group-', '') : sectionId;

            const contentElement = document.getElementById(`section-content-${contentId}`);
            const iconElement = document.getElementById(`toggle-icon-${contentId}`);

            if (contentElement.style.display === 'none') {
                // Expandir
                contentElement.style.display = 'block';
                iconElement.classList.remove('fa-chevron-down');
                iconElement.classList.add('fa-chevron-up');
            } else {
                // Colapsar
                contentElement.style.display = 'none';
                iconElement.classList.remove('fa-chevron-up');
                iconElement.classList.add('fa-chevron-down');
            }
        }

        // Función para expandir todas las secciones
        function expandAllSections() {
            if (!currentTopic || !currentTopic.sections) return;

            // Expandir secciones individuales
            currentTopic.sections.forEach(section => {
                const contentElement = document.getElementById(`section-content-${section.id}`);
                const iconElement = document.getElementById(`toggle-icon-${section.id}`);

                if (contentElement && iconElement) {
                    contentElement.style.display = 'block';
                    iconElement.classList.remove('fa-chevron-down');
                    iconElement.classList.add('fa-chevron-up');
                }
            });

            // Expandir grupos
            const groupIds = [...new Set(currentTopic.sections.filter(s => s.groupId).map(s => s.groupId))];
            groupIds.forEach(groupId => {
                const contentElement = document.getElementById(`section-content-group-${groupId}`);
                const iconElement = document.getElementById(`toggle-icon-group-${groupId}`);

                if (contentElement && iconElement) {
                    contentElement.style.display = 'block';
                    iconElement.classList.remove('fa-chevron-down');
                    iconElement.classList.add('fa-chevron-up');
                }
            });
        }

        // Función para colapsar todas las secciones
        function collapseAllSections() {
            if (!currentTopic || !currentTopic.sections) return;

            // Colapsar secciones individuales
            currentTopic.sections.forEach(section => {
                const contentElement = document.getElementById(`section-content-${section.id}`);
                const iconElement = document.getElementById(`toggle-icon-${section.id}`);

                if (contentElement && iconElement) {
                    contentElement.style.display = 'none';
                    iconElement.classList.remove('fa-chevron-up');
                    iconElement.classList.add('fa-chevron-down');
                }
            });

            // Colapsar grupos
            const groupIds = [...new Set(currentTopic.sections.filter(s => s.groupId).map(s => s.groupId))];
            groupIds.forEach(groupId => {
                const contentElement = document.getElementById(`section-content-group-${groupId}`);
                const iconElement = document.getElementById(`toggle-icon-group-${groupId}`);

                if (contentElement && iconElement) {
                    contentElement.style.display = 'none';
                    iconElement.classList.remove('fa-chevron-up');
                    iconElement.classList.add('fa-chevron-down');
                }
            });
        }

        function getSectionIcon(type) {
            switch (type) {
                case 'text':
                    return { class: 'fas', icon: 'fa-align-left', color: '#6c757d' };
                case 'youtube':
                    return { class: 'fab', icon: 'fa-youtube', color: '#ff0000' };
                case 'geogebra':
                    return { class: 'fas', icon: 'fa-calculator', color: '#007bff' };
                case 'image':
                    return { class: 'fas', icon: 'fa-image', color: '#9933ff' };
                case 'pdf':
                    return { class: 'fas', icon: 'fa-file-pdf', color: '#009933' };
                case 'html':
                    return { class: 'fab', icon: 'fa-html5', color: '#ff9900' };
                case 'activity':
                    return { class: 'fas', icon: 'fa-tasks', color: '#ff0099' };
                default:
                    return { class: 'fas', icon: 'fa-file', color: '#6c757d' };
            }
        }

        function getTypeName(type) {
            switch (type) {
                case 'text':
                    return 'Texto';
                case 'youtube':
                    return 'Video';
                case 'geogebra':
                    return 'GeoGebra';
                case 'image':
                    return 'Imagen';
                case 'pdf':
                    return 'PDF';
                case 'html':
                    return 'HTML';
                case 'activity':
                    return 'Actividad';
                default:
                    return 'Desconocido';
            }
        }
    </script>
</body>
</html>
