<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tema - MatemáticaWeb</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/section-editor.css">
    <link rel="stylesheet" href="../css/pdf-viewer.css">
    <style>
        /* Estilos para actividades */
        .activity-container {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        .activity-content {
            padding: 20px;
        }

        .activity-header {
            margin-bottom: 20px;
        }

        .activity-header h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: #0d6efd;
        }

        .activity-description {
            font-style: italic;
            color: #6c757d;
            margin-bottom: 20px;
        }

        .question-card {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .options-list {
            margin-top: 10px;
        }

        .form-check {
            margin-bottom: 10px;
        }

        .activity-feedback {
            margin-top: 20px;
        }

        .question-feedback .card {
            margin-bottom: 15px;
        }

        /* Estilos para el panel lateral desplegable */
        #mainContent.expanded {
            width: 100%;
            flex: 0 0 100%;
            max-width: 100%;
            transition: all 0.3s ease;
        }

        #sidebarColumn {
            transition: all 0.3s ease;
        }

        #sidebarColumn.hidden {
            display: none;
        }

        @media (max-width: 767.98px) {
            #toggleSidebarBtn {
                display: none;
            }
        }
    </style>
    <script src="../js/netlify-debug.js"></script>
    <script src="../js/content-loader.js"></script>
    <script src="../js/error-handler.js"></script>
    <script src="../js/polyfill.min.js"></script>
    <script src="../js/netlify-activity-handler.js"></script>
</head>
<body>
    <div id="header"></div>

    <main class="container mt-4">
        <div id="topicContent">
            <nav aria-label="breadcrumb" class="mb-4">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="../index.html">Inicio</a></li>
                    <li class="breadcrumb-item"><a href="#" id="courseLink">Curso</a></li>
                    <li class="breadcrumb-item active" id="topicTitle">Tema</li>
                </ol>
            </nav>

            <div class="row">
                <div class="col-md-8" id="mainContent">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h1 id="topicTitleHeader">Cargando...</h1>
                        <div class="navigation-buttons">
                            <button id="toggleSidebarBtn" class="btn btn-outline-secondary me-2">
                                <i class="fas fa-bars"></i> <span id="toggleSidebarText">Ocultar panel</span>
                            </button>
                            <a href="#" id="backToCourseBtn" class="btn btn-outline-primary me-2">
                                <i class="fas fa-arrow-left"></i> Volver al curso
                            </a>
                            <a href="../index.html" class="btn btn-outline-secondary">
                                <i class="fas fa-home"></i> Inicio
                            </a>
                        </div>
                    </div>

                    <div class="section-controls mb-4">
                        <button id="expandAllBtn" class="btn btn-sm btn-outline-primary me-2">
                            <i class="fas fa-expand-alt"></i> Expandir todo
                        </button>
                        <button id="collapseAllBtn" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-compress-alt"></i> Colapsar todo
                        </button>
                    </div>

                    <div class="topic-description mb-4" id="topicDescription">
                        <p class="lead">Cargando descripción...</p>
                    </div>

                    <div class="sections-container" id="sectionsContainer">
                        <div class="text-center py-5">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <p class="mt-3">Cargando secciones...</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4" id="sidebarColumn">
                    <div class="topic-sidebar" id="topicSidebar">
                        <div class="course-info">
                            <h4>Información del Curso</h4>
                            <div id="courseInfo">
                                <p class="text-muted">Cargando información del curso...</p>
                            </div>
                        </div>

                        <div class="topic-navigation mt-4">
                            <h4>Temas del Curso</h4>
                            <div id="topicsNavigation">
                                <p class="text-muted">Cargando temas...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="footer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/sample-data.js"></script>
    <script src="../js/data-persistence.js"></script>
    <script src="../js/data-manager.js"></script>
    <script src="../js/main.js"></script>
    <script>
        // Variables globales
        let currentTopicId = null;
        let currentTopic = null;
        let currentCourseId = null;
        let currentCourse = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadComponent('header', '../components/header.html');
            loadComponent('footer', '../components/footer.html');

            // Configurar el botón de mostrar/ocultar panel lateral
            setupSidebarToggle();

            // Obtener los IDs de la URL
            const urlParams = new URLSearchParams(window.location.search);
            currentTopicId = parseInt(urlParams.get('id'));
            currentCourseId = parseInt(urlParams.get('courseId'));

            if (!currentTopicId || !currentCourseId) {
                showError('Parámetros incorrectos', 'No se pudo cargar el tema porque faltan parámetros.');
                return;
            }

            // Inicializar sistema de persistencia antes de cargar los datos
            if (typeof initializeDataSystem === 'function') {
                console.log('Inicializando sistema de persistencia en topics/view.html...');
                initializeDataSystem().then(() => {
                    // Cargar los datos una vez que el sistema de persistencia esté inicializado
                    loadData();
                });
            } else {
                // Si no hay sistema de persistencia, cargar datos directamente
                loadData();
            }
        });

        function loadData() {
            try {
                // Obtener el curso
                currentCourse = DataManager.getCourseById(currentCourseId);
                if (!currentCourse) {
                    showError('Curso no encontrado', 'El curso solicitado no existe.');
                    return;
                }

                // Obtener el tema
                currentTopic = DataManager.getTopicById(currentTopicId);
                if (!currentTopic) {
                    showError('Tema no encontrado', 'El tema solicitado no existe.');
                    return;
                }

                // Actualizar la navegación
                document.title = `${currentTopic.title} - MatemáticaWeb`;
                document.getElementById('topicTitle').textContent = currentTopic.title;
                document.getElementById('topicTitleHeader').textContent = currentTopic.title;
                document.getElementById('topicDescription').innerHTML = `<p class="lead">${currentTopic.description}</p>`;

                const courseLink = document.getElementById('courseLink');
                courseLink.textContent = currentCourse.title;
                courseLink.href = `../courses/view.html?id=${currentCourse.id}`;

                // Configurar el botón para volver al curso
                const backToCourseBtn = document.getElementById('backToCourseBtn');
                backToCourseBtn.href = `../courses/view.html?id=${currentCourse.id}`;

                // Mostrar información del curso
                document.getElementById('courseInfo').innerHTML = `
                    <div class="course-info-card">
                        <div class="course-info-icon" style="background-color: ${currentCourse.color || '#6c757d'}">
                            <i class="${currentCourse.icon || 'fas fa-book'}"></i>
                        </div>
                        <div class="course-info-content">
                            <h5>${currentCourse.title}</h5>
                            <p class="small">${currentCourse.description}</p>
                            <a href="../courses/view.html?id=${currentCourse.id}" class="btn btn-sm btn-outline-primary">
                                Ver todos los temas
                            </a>
                        </div>
                    </div>
                `;

                // Mostrar navegación de temas
                loadTopicsNavigation();

                // Cargar las secciones del tema
                loadSections();
            } catch (error) {
                console.error('Error al cargar los datos:', error);
                showError('Error', 'Ocurrió un error al cargar el contenido.');
            }
        }

        function loadTopicsNavigation() {
            // Obtener todos los temas del curso
            const topics = DataManager.getTopicsByCourse(currentCourseId);

            if (topics.length === 0) {
                document.getElementById('topicsNavigation').innerHTML = '<p class="text-muted">Este curso no tiene temas.</p>';
                return;
            }

            // Crear la lista de temas
            const topicsHtml = topics.map(topic => {
                const isActive = topic.id === currentTopicId;
                return `
                    <div class="topic-nav-item ${isActive ? 'active' : ''}">
                        <a href="view.html?id=${topic.id}&courseId=${currentCourseId}" class="topic-nav-link">
                            <div class="topic-nav-icon">
                                <i class="${topic.icon || 'fas fa-book'}"></i>
                            </div>
                            <div class="topic-nav-title">${topic.title}</div>
                        </a>
                    </div>
                `;
            }).join('');

            document.getElementById('topicsNavigation').innerHTML = topicsHtml;
        }

        function loadSections() {
            console.log('Cargando secciones para el tema:', currentTopic.title);
            const sectionsContainer = document.getElementById('sectionsContainer');

            // Obtener secciones del tema y del sistema de persistencia
            let sections = [];

            // Primero intentar obtener las secciones del tema
            if (currentTopic.sections && Array.isArray(currentTopic.sections) && currentTopic.sections.length > 0) {
                sections = [...currentTopic.sections];
                console.log(`Encontradas ${sections.length} secciones en el tema`);
            }

            // Si no hay secciones en el tema o son pocas, intentar obtenerlas del sistema de persistencia
            if (sections.length === 0 && typeof DataPersistence !== 'undefined') {
                console.log('Buscando secciones en el sistema de persistencia...');
                const allSections = DataPersistence.getAllDataAsArray('sections');

                // Filtrar secciones que pertenezcan al tema actual
                const persistenceSections = allSections.filter(s => s.topicId == currentTopicId);
                console.log(`Encontradas ${persistenceSections.length} secciones en el sistema de persistencia`);

                if (persistenceSections.length > 0) {
                    sections = persistenceSections;
                }
            }

            // Asignar las secciones al tema actual para procesamiento posterior
            currentTopic.sections = sections;

            // Verificar si el tema tiene secciones
            if (!currentTopic.sections || currentTopic.sections.length === 0) {
                sectionsContainer.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Este tema aún no tiene secciones.
                    </div>
                `;
                return;
            }

            // Crear el contenido para cada sección
            let sectionsHtml = '';
            let sectionCounter = 1;

            // Crear una estructura ordenada de elementos (secciones y grupos)
            const allSectionsWithOrder = [];
            const groupMap = {};

            // Primero, recopilar todas las secciones no agrupadas
            currentTopic.sections.forEach(section => {
                if (!section.groupId) {
                    allSectionsWithOrder.push({
                        type: 'section',
                        data: section,
                        order: section.order || 0
                    });
                }
            });

            // Luego, recopilar y organizar todos los grupos
            currentTopic.sections.forEach(section => {
                if (section.groupId) {
                    if (!groupMap[section.groupId]) {
                        groupMap[section.groupId] = {
                            id: section.groupId,
                            name: section.groupName || 'Grupo sin nombre',
                            sections: [],
                            order: section.order || 0
                        };
                    } else if ((section.order || 0) < groupMap[section.groupId].order) {
                        // Actualizar el orden del grupo si encontramos una sección con orden menor
                        groupMap[section.groupId].order = section.order || 0;
                    }

                    // Agregar la sección al grupo
                    groupMap[section.groupId].sections.push(section);
                }
            });

            // Ordenar las secciones dentro de cada grupo
            Object.values(groupMap).forEach(group => {
                group.sections.sort((a, b) => (a.order || 0) - (b.order || 0));
            });

            // Agregar los grupos a la lista de elementos
            Object.values(groupMap).forEach(group => {
                allSectionsWithOrder.push({
                    type: 'group',
                    data: group,
                    order: group.order
                });
            });

            // Ordenar todos los elementos por su orden
            allSectionsWithOrder.sort((a, b) => a.order - b.order);

            // Procesar todas las secciones y grupos en el orden correcto
            allSectionsWithOrder.forEach(item => {
                if (item.type === 'section') {
                    // Sección individual normal
                    const section = item.data;
                    sectionsHtml += `
                        <div class="section-block" id="section-${section.id}">
                            <div class="section-header" role="button" onclick="toggleSection(${section.id})">
                                <div class="section-number">${sectionCounter++}</div>
                                <h2 class="section-title">${section.title}</h2>
                                <div class="section-controls">
                                    <div class="section-type-badge">
                                        <i class="${getSectionIcon(section.type).class} ${getSectionIcon(section.type).icon}" style="color: ${getSectionIcon(section.type).color};"></i> ${getTypeName(section.type)}
                                    </div>
                                    <button class="btn btn-sm btn-link section-toggle" aria-label="Expandir/Colapsar sección">
                                        <i class="fas fa-chevron-down" id="toggle-icon-${section.id}"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="section-content" id="section-content-${section.id}" style="display: none;">
                                ${renderSectionContent(section)}
                            </div>
                        </div>
                    `;
                } else if (item.type === 'group') {
                    // Es parte de un grupo, mostrar el grupo
                    const group = item.data;

                    // Crear el encabezado del grupo
                    sectionsHtml += `
                        <div class="section-block section-group" id="section-group-${group.id}">
                            <div class="section-header" role="button" onclick="toggleSection('group-${group.id}')">
                                <div class="section-number">${sectionCounter++}</div>
                                <h2 class="section-title">${group.name}</h2>
                                <div class="section-controls">
                                    <div class="section-type-badge">
                                        <i class="fas fa-layer-group"></i> Grupo
                                    </div>
                                    <button class="btn btn-sm btn-link section-toggle" aria-label="Expandir/Colapsar grupo">
                                        <i class="fas fa-chevron-down" id="toggle-icon-group-${group.id}"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="section-content" id="section-content-group-${group.id}" style="display: none;">
                    `;

                    // Agregar el contenido de todas las secciones del grupo
                    group.sections.forEach(groupSection => {
                        sectionsHtml += renderSectionContent(groupSection);
                        // Marcar la sección como procesada
                        groupSection._processed = true;
                    });

                    // Cerrar el div del grupo
                    sectionsHtml += `
                            </div>
                        </div>
                    `;
                } else {
                    // Sección individual normal
                    sectionsHtml += `
                        <div class="section-block" id="section-${section.id}">
                            <div class="section-header" role="button" onclick="toggleSection(${section.id})">
                                <div class="section-number">${sectionCounter++}</div>
                                <h2 class="section-title">${section.title}</h2>
                                <div class="section-controls">
                                    <div class="section-type-badge">
                                        <i class="${getSectionIcon(section.type).class} ${getSectionIcon(section.type).icon}" style="color: ${getSectionIcon(section.type).color};"></i> ${getTypeName(section.type)}
                                    </div>
                                    <button class="btn btn-sm btn-link section-toggle" aria-label="Expandir/Colapsar sección">
                                        <i class="fas fa-chevron-down" id="toggle-icon-${section.id}"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="section-content" id="section-content-${section.id}" style="display: none;">
                                ${renderSectionContent(section)}
                            </div>
                        </div>
                    `;
                }
            });

            sectionsContainer.innerHTML = sectionsHtml;

            // Configurar los botones de expandir/colapsar todo
            document.getElementById('expandAllBtn').addEventListener('click', expandAllSections);
            document.getElementById('collapseAllBtn').addEventListener('click', collapseAllSections);
        }

        function renderSectionContent(section) {
            console.log('Renderizando contenido para sección:', section.title, 'tipo:', section.type);
            let contentHtml = '';

            switch (section.type) {
                case 'text':
                    contentHtml = `
                        <div class="text-content">
                            ${section.content}
                        </div>
                    `;
                    break;

                case 'youtube':
                    contentHtml = `
                        <div class="youtube-container">
                            <iframe src="https://www.youtube.com/embed/${section.content}"
                                    frameborder="0" allowfullscreen style="width:100%; height:400px;"></iframe>
                        </div>
                    `;
                    break;

                case 'geogebra':
                    contentHtml = `
                        <div class="geogebra-container">
                            <iframe src="https://www.geogebra.org/material/iframe/id/${section.content}"
                                    frameborder="0" style="width:100%; height:500px;"></iframe>
                        </div>
                    `;
                    break;

                case 'image':
                    contentHtml = `
                        <div class="section-preview-content">
                            <div class="image-container text-center">
                                <img src="../activities/images/${section.content}" alt="${section.title}" style="max-width: 100%; max-height: 600px;">
                            </div>
                        </div>
                    `;
                    break;

                case 'pdf':
                    contentHtml = `
                        <div class="section-preview-content">
                            <div class="pdf-container">
                                <div class="pdf-viewer mb-3">
                                    <object data="../activities/pdf/${section.content}" type="application/pdf" width="100%" height="600px">
                                        <div class="pdf-fallback">
                                            <p>Tu navegador no puede mostrar el PDF incrustado. Puedes:</p>
                                            <a href="../activities/pdf/${section.content}" target="_blank" download class="btn btn-primary">
                                                <i class="fas fa-file-pdf me-2"></i> Descargar PDF
                                            </a>
                                            <a href="../activities/pdf/${section.content}" target="_blank" class="btn btn-secondary ms-2">
                                                <i class="fas fa-external-link-alt me-2"></i> Abrir en nueva pestaña
                                            </a>
                                        </div>
                                    </object>
                                </div>
                                <div class="pdf-controls">
                                    <a href="../activities/pdf/${section.content}" target="_blank" download class="btn btn-primary">
                                        <i class="fas fa-file-pdf me-2"></i> Descargar PDF
                                    </a>
                                    <a href="../activities/pdf/${section.content}" target="_blank" class="btn btn-secondary">
                                        <i class="fas fa-external-link-alt me-2"></i> Abrir en nueva pestaña
                                    </a>
                                </div>
                            </div>
                        </div>
                    `;
                    break;

                case 'html':
                    // Verificar si el archivo existe
                    // Usar rutas absolutas para Netlify
                    const isNetlifyEnv = window.location.hostname.includes('netlify.app') ||
                                       window.location.hostname.includes('netlify.com');

                    // Construir la ruta base dependiendo del entorno
                    const basePath = isNetlifyEnv ?
                        (window.location.origin + '/activities/html/') :
                        '../activities/html/';

                    const htmlPath = basePath + section.content;
                    const fallbackHtmlPath = basePath + 'ejemplo-simple.html';

                    console.log('Ruta HTML:', htmlPath);
                    console.log('Ruta fallback HTML:', fallbackHtmlPath);

                    // Detectar si estamos en Netlify
                    const isNetlify = window.location.hostname.includes('netlify.app') ||
                                     window.location.hostname.includes('netlify.com');

                    console.log('Cargando HTML en ' + (isNetlify ? 'Netlify' : 'Local') + ': ' + htmlPath);
                    console.log('Tipo de contenido de la sección:', section.type);
                    console.log('Contenido de la sección:', section.content);

                    // En Netlify, usar iframe como antes (ya que el HTML estático funciona bien en Netlify)
                    if (isNetlify) {
                        console.log('Entorno Netlify detectado, cargando HTML con iframe');

                        // Crear un ID único para el contenedor
                        const containerId = `html-container-${section.id}`;

                        // Crear el contenedor para el contenido HTML
                        contentHtml = `
                            <div class="html-container">
                                <div id="${containerId}" class="html-content" style="min-height:300px;"></div>
                            </div>
                        `;

                        // Cargar el contenido HTML usando AJAX en lugar de iframe
                        setTimeout(() => {
                            console.log('Cargando contenido HTML usando AJAX:', htmlPath);
                            loadHTMLContent(htmlPath, containerId, fallbackHtmlPath);
                        }, 100);
                    } else {
                        // En local, usar iframe como antes
                        contentHtml = `
                            <div class="html-container">
                                <iframe src="${htmlPath}" frameborder="0" style="width:100%; height:500px;"
                                        id="html-iframe-${section.id}"></iframe>
                            </div>
                        `;

                        // Verificar si el archivo existe después de cargar
                        setTimeout(() => {
                            const iframe = document.getElementById(`html-iframe-${section.id}`);
                            if (iframe) {
                                fetch(htmlPath, { method: 'HEAD', cache: 'no-store' })
                                    .then(response => {
                                        if (!response.ok) {
                                            console.warn('Archivo ' + htmlPath + ' no encontrado, usando fallback');
                                            iframe.src = fallbackHtmlPath;
                                        }
                                    })
                                    .catch(error => {
                                        console.error('Error verificando archivo ' + htmlPath + ':', error);
                                        iframe.src = fallbackHtmlPath;
                                    });
                            }
                        }, 500);
                    }
                    break;

                case 'activity':
                    console.log('Renderizando actividad con ID:', section.content);

                    // Intentar cargar la actividad con varias claves posibles
                    const activityId = section.content.replace('activity_', '');
                    const activityKey1 = `activity_${activityId}`;
                    const activityKey2 = section.content; // Usar el ID tal como está
                    const activityKey3 = `activity_data_${activityId}`;

                    // Crear un ID único para el contenedor
                    const containerId = `activity-container-${section.id}`;

                    console.log(`Buscando actividad con claves: ${activityKey1}, ${activityKey2}, ${activityKey3}`);

                    // Intentar cargar la actividad desde localStorage con todas las claves posibles
                    let activityData = null;
                    let activityStr = localStorage.getItem(activityKey1) || localStorage.getItem(activityKey2) || localStorage.getItem(activityKey3);

                    try {
                        if (activityStr) {
                            activityData = JSON.parse(activityStr);
                            console.log(`Actividad encontrada: ${activityData.title || 'Sin título'}`);
                        } else {
                            console.error(`No se encontró la actividad con ninguna de las claves`);
                        }
                    } catch (e) {
                        console.error('Error al parsear actividad:', e);
                    }

                    if (activityData) {
                        // Generar HTML para la actividad
                        contentHtml = `
                            <table class="activity-container" cellpadding="0" cellspacing="0" border="0" width="100%">
                                <tr>
                                    <td>
                                        <div id="${containerId}" class="activity-content">
                                            <div class="activity-header">
                                                <h3>${activityData.title || 'Actividad sin título'}</h3>
                                                <p class="activity-description">${activityData.description || ''}</p>
                                            </div>
                                            <form id="activity-form-${section.id}" class="activity-form">
                                                ${renderActivityQuestions(activityData, section.id)}
                                                <div class="d-grid gap-2 col-md-6 mx-auto mt-4">
                                                    <button type="button" class="btn btn-success btn-lg" onclick="checkActivityAnswers('${section.id}', '${activityId}')">
                                                        <i class="fas fa-paper-plane me-2"></i> Enviar respuestas
                                                    </button>
                                                </div>
                                            </form>
                                            <div id="activity-feedback-${section.id}" class="activity-feedback mt-3" style="display:none;"></div>
                                        </div>
                                    </td>
                                </tr>
                            </table>
                        `;
                    } else {
                        // Mostrar mensaje de error si no se encuentra la actividad
                        contentHtml = `
                            <table class="activity-container" cellpadding="0" cellspacing="0" border="0" width="100%">
                                <tr>
                                    <td>
                                        <div class="alert alert-warning">
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            <strong>Actividad no encontrada</strong>
                                            <p>No se pudo cargar la actividad con ID: ${activityId}</p>
                                        </div>
                                    </td>
                                </tr>
                            </table>
                        `;
                    }
                    break;

                default:
                    contentHtml = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Tipo de contenido no soportado.
                        </div>
                    `;
            }

            return contentHtml;
        }

        function showError(title, message) {
            document.getElementById('sectionsContainer').innerHTML = `
                <div class="alert alert-danger">
                    <h4>${title}</h4>
                    <p>${message}</p>
                    <a href="../index.html" class="btn btn-outline-primary mt-3">
                        <i class="fas fa-home"></i> Volver al inicio
                    </a>
                </div>
            `;

            document.getElementById('courseInfo').innerHTML = `
                <p class="text-muted">Información no disponible</p>
            `;

            document.getElementById('topicsNavigation').innerHTML = `
                <p class="text-muted">Información no disponible</p>
            `;
        }

        // Función para expandir/colapsar una sección
        function toggleSection(sectionId) {
            // Comprobar si es un ID de grupo o de sección individual
            const isGroup = typeof sectionId === 'string' && sectionId.startsWith('group-');
            const contentId = isGroup ? sectionId : sectionId;
            const actualId = isGroup ? sectionId.replace('group-', '') : sectionId;

            const contentElement = document.getElementById(`section-content-${contentId}`);
            const iconElement = document.getElementById(`toggle-icon-${contentId}`);

            if (contentElement.style.display === 'none') {
                // Expandir
                contentElement.style.display = 'block';
                iconElement.classList.remove('fa-chevron-down');
                iconElement.classList.add('fa-chevron-up');
            } else {
                // Colapsar
                contentElement.style.display = 'none';
                iconElement.classList.remove('fa-chevron-up');
                iconElement.classList.add('fa-chevron-down');
            }
        }

        // Función para expandir todas las secciones
        function expandAllSections() {
            if (!currentTopic || !currentTopic.sections) return;

            // Expandir secciones individuales
            currentTopic.sections.forEach(section => {
                const contentElement = document.getElementById(`section-content-${section.id}`);
                const iconElement = document.getElementById(`toggle-icon-${section.id}`);

                if (contentElement && iconElement) {
                    contentElement.style.display = 'block';
                    iconElement.classList.remove('fa-chevron-down');
                    iconElement.classList.add('fa-chevron-up');
                }
            });

            // Expandir grupos
            const groupIds = [...new Set(currentTopic.sections.filter(s => s.groupId).map(s => s.groupId))];
            groupIds.forEach(groupId => {
                const contentElement = document.getElementById(`section-content-group-${groupId}`);
                const iconElement = document.getElementById(`toggle-icon-group-${groupId}`);

                if (contentElement && iconElement) {
                    contentElement.style.display = 'block';
                    iconElement.classList.remove('fa-chevron-down');
                    iconElement.classList.add('fa-chevron-up');
                }
            });
        }

        // Función para colapsar todas las secciones
        function collapseAllSections() {
            if (!currentTopic || !currentTopic.sections) return;

            // Colapsar secciones individuales
            currentTopic.sections.forEach(section => {
                const contentElement = document.getElementById(`section-content-${section.id}`);
                const iconElement = document.getElementById(`toggle-icon-${section.id}`);

                if (contentElement && iconElement) {
                    contentElement.style.display = 'none';
                    iconElement.classList.remove('fa-chevron-up');
                    iconElement.classList.add('fa-chevron-down');
                }
            });

            // Colapsar grupos
            const groupIds = [...new Set(currentTopic.sections.filter(s => s.groupId).map(s => s.groupId))];
            groupIds.forEach(groupId => {
                const contentElement = document.getElementById(`section-content-group-${groupId}`);
                const iconElement = document.getElementById(`toggle-icon-group-${groupId}`);

                if (contentElement && iconElement) {
                    contentElement.style.display = 'none';
                    iconElement.classList.remove('fa-chevron-up');
                    iconElement.classList.add('fa-chevron-down');
                }
            });
        }

        function getSectionIcon(type) {
            switch (type) {
                case 'text':
                    return { class: 'fas', icon: 'fa-align-left', color: '#6c757d' };
                case 'youtube':
                    return { class: 'fab', icon: 'fa-youtube', color: '#ff0000' };
                case 'geogebra':
                    return { class: 'fas', icon: 'fa-calculator', color: '#007bff' };
                case 'image':
                    return { class: 'fas', icon: 'fa-image', color: '#9933ff' };
                case 'pdf':
                    return { class: 'fas', icon: 'fa-file-pdf', color: '#009933' };
                case 'html':
                    return { class: 'fab', icon: 'fa-html5', color: '#ff9900' };
                case 'activity':
                    return { class: 'fas', icon: 'fa-tasks', color: '#ff0099' };
                default:
                    return { class: 'fas', icon: 'fa-file', color: '#6c757d' };
            }
        }

        function getTypeName(type) {
            switch (type) {
                case 'text':
                    return 'Texto';
                case 'youtube':
                    return 'Video';
                case 'geogebra':
                    return 'GeoGebra';
                case 'image':
                    return 'Imagen';
                case 'pdf':
                    return 'PDF';
                case 'html':
                    return 'HTML';
                case 'activity':
                    return 'Actividad';
                default:
                    return 'Desconocido';
            }
        }

        // Función para renderizar las preguntas de una actividad
        // Función para verificar las respuestas de una actividad
        function checkActivityAnswers(sectionId, activityId) {
            console.log(`Verificando respuestas para actividad ${activityId} en sección ${sectionId}`);

            // Limpiar el ID de la actividad (quitar prefijo si existe)
            const cleanActivityId = activityId.replace('activity_', '');
            const activityKey = `activity_${cleanActivityId}`;

            // Cargar la actividad desde localStorage
            let activityData = null;
            try {
                activityData = JSON.parse(localStorage.getItem(activityKey));
            } catch (e) {
                console.error('Error al cargar actividad para verificación:', e);
                showInlineActivityFeedback(sectionId, 'error', 'Error al cargar la actividad');
                return;
            }

            if (!activityData) {
                console.error('No se encontró la actividad para verificación');
                showInlineActivityFeedback(sectionId, 'error', 'No se encontró la actividad');
                return;
            }

            // Obtener las respuestas del usuario
            const userAnswers = [];
            const activityType = activityData.type || 'multiple-choice';

            activityData.questions.forEach((question, index) => {
                const inputName = `question_${sectionId}_${index}`;
                let userAnswer = null;

                switch (activityType) {
                    case 'multiple-choice':
                        const selectedOption = document.querySelector(`input[name="${inputName}"]:checked`);
                        userAnswer = selectedOption ? parseInt(selectedOption.value) : null;
                        break;

                    case 'true-false':
                        const selectedValue = document.querySelector(`input[name="${inputName}"]:checked`);
                        if (selectedValue) {
                            userAnswer = selectedValue.value === 'true';
                        }
                        break;

                    case 'short-answer':
                        const inputField = document.querySelector(`input[name="${inputName}"]`);
                        userAnswer = inputField ? inputField.value.trim() : null;
                        break;
                }

                // Obtener la respuesta correcta (puede estar en diferentes propiedades según el tipo)
                let correctAnswer = question.correctAnswer;

                // Para compatibilidad con diferentes formatos de actividades
                if (correctAnswer === undefined && activityType === 'multiple-choice' && question.correctOption !== undefined) {
                    correctAnswer = question.correctOption;
                }

                if (correctAnswer === undefined && activityType === 'short-answer' && question.correctAnswers) {
                    correctAnswer = question.correctAnswers[0];
                }

                console.log(`Pregunta ${index} - Respuesta correcta:`, correctAnswer);

                userAnswers.push({
                    questionIndex: index,
                    userAnswer: userAnswer,
                    correctAnswer: correctAnswer,
                    isCorrect: compareAnswers(userAnswer, correctAnswer, activityType)
                });
            });

            // Calcular resultados
            const totalQuestions = userAnswers.length;
            const answeredQuestions = userAnswers.filter(a => a.userAnswer !== null && a.userAnswer !== '').length;
            const correctAnswers = userAnswers.filter(a => a.isCorrect).length;

            // Verificar si todas las preguntas fueron respondidas
            if (answeredQuestions < totalQuestions) {
                showInlineActivityFeedback(sectionId, 'warning', 'Por favor, responde todas las preguntas antes de enviar.');
                return;
            }

            // Calcular el tipo de feedback basado en los resultados
            const percentage = Math.round((correctAnswers / totalQuestions) * 100);
            const feedbackType = percentage >= 70 ? 'success' : (percentage >= 40 ? 'warning' : 'danger');

            // Mostrar resumen de resultados solo si hay más de una pregunta
            const summaryElement = document.getElementById(`activity-summary-${sectionId}`);
            if (summaryElement) {
                // Solo mostrar el resumen si hay más de una pregunta
                if (totalQuestions > 1) {
                    summaryElement.innerHTML = `
                        <div class="alert alert-${feedbackType} mb-4">
                            <h5><i class="fas ${percentage >= 70 ? 'fa-check-circle' : 'fa-info-circle'} me-2"></i> Resultados</h5>
                            <p>Has respondido correctamente ${correctAnswers} de ${totalQuestions} preguntas (${percentage}%).</p>
                            <div class="progress mb-2">
                                <div class="progress-bar bg-${feedbackType}" role="progressbar" style="width: ${percentage}%"
                                    aria-valuenow="${percentage}" aria-valuemin="0" aria-valuemax="100">${percentage}%</div>
                            </div>
                        </div>
                    `;
                    summaryElement.style.display = 'block';
                } else {
                    // Para una sola pregunta, no mostrar el resumen
                    summaryElement.style.display = 'none';
                }
            }

            // Mostrar feedback para cada pregunta individualmente
            userAnswers.forEach((answer) => {
                const questionIndex = answer.questionIndex;
                const questionCard = document.querySelector(`#activity-form-${sectionId} [data-question-index="${questionIndex}"]`);
                if (!questionCard) return;

                // Limpiar feedback anterior si existe
                const existingFeedback = questionCard.querySelector('.question-feedback');
                if (existingFeedback) {
                    existingFeedback.remove();
                }

                // Crear elemento de feedback
                const feedbackDiv = document.createElement('div');
                feedbackDiv.className = `question-feedback alert ${answer.isCorrect ? 'alert-success' : 'alert-danger'} mt-3`;

                // Contenido del feedback
                if (answer.isCorrect) {
                    feedbackDiv.innerHTML = `
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>¡Correcto!</strong>
                    `;
                } else {
                    let feedbackContent = `
                        <i class="fas fa-times-circle me-2"></i>
                        <strong>Incorrecto.</strong>
                    `;

                    // Añadir la respuesta correcta si está disponible
                    if (answer.correctAnswer !== undefined && answer.correctAnswer !== null) {
                        const question = activityData.questions[questionIndex];

                        switch (activityType) {
                            case 'multiple-choice':
                                if (question.options && question.options[answer.correctAnswer] !== undefined) {
                                    feedbackContent += `<p class="mb-0 mt-2">Respuesta correcta: ${question.options[answer.correctAnswer]}</p>`;
                                }
                                break;

                            case 'true-false':
                                feedbackContent += `<p class="mb-0 mt-2">Respuesta correcta: ${answer.correctAnswer === true ? 'Verdadero' : 'Falso'}</p>`;
                                break;

                            case 'short-answer':
                                feedbackContent += `<p class="mb-0 mt-2">Respuesta correcta: ${answer.correctAnswer}</p>`;
                                break;
                        }
                    }

                    feedbackDiv.innerHTML = feedbackContent;
                }

                // Añadir el feedback a la tarjeta de pregunta
                questionCard.appendChild(feedbackDiv);

                // Marcar visualmente las opciones correctas/incorrectas
                switch (activityType) {
                    case 'multiple-choice':
                    case 'true-false':
                        const options = questionCard.querySelectorAll('.form-check');
                        options.forEach((option, optIndex) => {
                            const input = option.querySelector('input');
                            const label = option.querySelector('label');

                            if (input && input.checked) {
                                if (answer.isCorrect) {
                                    // Respuesta correcta
                                    label.classList.add('text-success', 'fw-bold');
                                    option.classList.add('border-success', 'border', 'rounded', 'p-2');
                                } else {
                                    // Respuesta incorrecta
                                    label.classList.add('text-danger', 'fw-bold');
                                    option.classList.add('border-danger', 'border', 'rounded', 'p-2');
                                }
                            }

                            // Marcar la opción correcta si la respuesta fue incorrecta
                            if (!answer.isCorrect && activityType === 'multiple-choice' &&
                                optIndex === answer.correctAnswer) {
                                const correctLabel = option.querySelector('label');
                                if (correctLabel) {
                                    correctLabel.classList.add('text-success');
                                }
                            }

                            if (!answer.isCorrect && activityType === 'true-false') {
                                const value = input.value === 'true';
                                if (value === answer.correctAnswer) {
                                    const correctLabel = option.querySelector('label');
                                    if (correctLabel) {
                                        correctLabel.classList.add('text-success');
                                    }
                                }
                            }

                            // Deshabilitar las opciones después de enviar
                            if (input) {
                                input.disabled = true;
                            }
                        });
                        break;

                    case 'short-answer':
                        const inputField = questionCard.querySelector('input[type="text"]');
                        if (inputField) {
                            inputField.disabled = true;
                            if (answer.isCorrect) {
                                inputField.classList.add('border-success', 'bg-success', 'bg-opacity-10', 'text-success', 'fw-bold');
                            } else {
                                inputField.classList.add('border-danger', 'bg-danger', 'bg-opacity-10', 'text-danger', 'fw-bold');
                            }
                        }
                        break;
                }
            });

            // Deshabilitar el botón de enviar
            const submitButton = document.querySelector(`#activity-form-${sectionId} button[type="button"]`);
            if (submitButton) {
                submitButton.disabled = true;
                submitButton.innerHTML = '<i class="fas fa-check me-2"></i> Respuestas enviadas';
                submitButton.classList.remove('btn-success');
                submitButton.classList.add('btn-secondary');
            }

            // Hacer scroll al elemento apropiado
            if (totalQuestions > 1 && summaryElement) {
                // Si hay más de una pregunta, hacer scroll al resumen
                summaryElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else if (userAnswers.length > 0) {
                // Si hay una sola pregunta, hacer scroll a la primera pregunta
                const firstQuestionCard = document.querySelector(`#activity-form-${sectionId} [data-question-index="${userAnswers[0].questionIndex}"]`);
                if (firstQuestionCard) {
                    firstQuestionCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }
        }

        // Función para comparar respuestas
        function compareAnswers(userAnswer, correctAnswer, activityType) {
            if (userAnswer === null || userAnswer === undefined || userAnswer === '') {
                return false;
            }

            console.log('Comparando respuestas:', { userAnswer, correctAnswer, activityType });

            switch (activityType) {
                case 'multiple-choice':
                    // Asegurarse de que ambos sean números para comparación
                    if (typeof userAnswer === 'string') {
                        userAnswer = parseInt(userAnswer);
                    }
                    if (typeof correctAnswer === 'string') {
                        correctAnswer = parseInt(correctAnswer);
                    }

                    console.log('Multiple choice comparison:', { userAnswer, correctAnswer, result: userAnswer === correctAnswer });
                    return userAnswer === correctAnswer;

                case 'true-false':
                    // Convertir a booleano si es necesario
                    if (typeof userAnswer === 'string') {
                        userAnswer = userAnswer.toLowerCase() === 'true';
                    }
                    if (typeof correctAnswer === 'string') {
                        correctAnswer = correctAnswer.toLowerCase() === 'true';
                    }

                    console.log('True-false comparison:', { userAnswer, correctAnswer, result: userAnswer === correctAnswer });
                    return userAnswer === correctAnswer;

                case 'short-answer':
                    // Comparación insensible a mayúsculas/minúsculas
                    if (typeof userAnswer !== 'string' || typeof correctAnswer !== 'string') {
                        console.log('Short answer types:', { userAnswerType: typeof userAnswer, correctAnswerType: typeof correctAnswer });
                        return false;
                    }

                    const result = userAnswer.toLowerCase() === correctAnswer.toLowerCase();
                    console.log('Short answer comparison:', { userAnswer, correctAnswer, result });
                    return result;

                default:
                    console.log('Unknown activity type:', activityType);
                    return false;
            }
        }

        // Función para mostrar feedback de actividad en línea
        function showInlineActivityFeedback(sectionId, type, message) {
            // Buscar el contenedor de la actividad
            const activityContainer = document.querySelector(`#activity-form-${sectionId}`);
            if (!activityContainer) return;

            // Buscar o crear el elemento de feedback
            let feedbackElement = document.getElementById(`activity-inline-feedback-${sectionId}`);
            if (!feedbackElement) {
                feedbackElement = document.createElement('div');
                feedbackElement.id = `activity-inline-feedback-${sectionId}`;
                feedbackElement.className = 'activity-inline-feedback mb-3';

                // Insertar al principio del formulario
                activityContainer.insertBefore(feedbackElement, activityContainer.firstChild);
            }

            // Determinar la clase de alerta según el tipo
            let alertClass = 'alert-info';
            let icon = 'fa-info-circle';
            switch (type) {
                case 'success':
                    alertClass = 'alert-success';
                    icon = 'fa-check-circle';
                    break;
                case 'warning':
                    alertClass = 'alert-warning';
                    icon = 'fa-exclamation-triangle';
                    break;
                case 'danger':
                case 'error':
                    alertClass = 'alert-danger';
                    icon = 'fa-times-circle';
                    break;
            }

            // Mostrar el mensaje
            feedbackElement.innerHTML = `
                <div class="alert ${alertClass} d-flex align-items-center">
                    <i class="fas ${icon} me-2"></i>
                    <div>${message}</div>
                </div>
            `;
            feedbackElement.style.display = 'block';

            // Hacer scroll al feedback
            feedbackElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Función para mostrar feedback de actividad (mantener por compatibilidad)
        function showActivityFeedback(sectionId, type, message) {
            showInlineActivityFeedback(sectionId, type, message);
        }

        // Función para configurar el botón de mostrar/ocultar panel lateral
        function setupSidebarToggle() {
            const toggleBtn = document.getElementById('toggleSidebarBtn');
            const mainContent = document.getElementById('mainContent');
            const sidebarColumn = document.getElementById('sidebarColumn');
            const toggleText = document.getElementById('toggleSidebarText');

            if (!toggleBtn || !mainContent || !sidebarColumn || !toggleText) {
                console.error('No se encontraron los elementos necesarios para el toggle del sidebar');
                return;
            }

            // Verificar si hay una preferencia guardada
            const sidebarHidden = localStorage.getItem('topic_sidebar_hidden') === 'true';

            // Aplicar estado inicial
            if (sidebarHidden) {
                mainContent.classList.add('expanded');
                sidebarColumn.classList.add('hidden');
                toggleText.textContent = 'Mostrar panel';
            }

            toggleBtn.addEventListener('click', function() {
                // Cambiar estado
                const isCurrentlyHidden = sidebarColumn.classList.contains('hidden');

                if (isCurrentlyHidden) {
                    // Mostrar panel
                    mainContent.classList.remove('expanded');
                    sidebarColumn.classList.remove('hidden');
                    toggleText.textContent = 'Ocultar panel';
                    localStorage.setItem('topic_sidebar_hidden', 'false');
                } else {
                    // Ocultar panel
                    mainContent.classList.add('expanded');
                    sidebarColumn.classList.add('hidden');
                    toggleText.textContent = 'Mostrar panel';
                    localStorage.setItem('topic_sidebar_hidden', 'true');
                }
            });
        }

        function renderActivityQuestions(activityData, sectionId) {
            if (!activityData.questions || !activityData.questions.length) {
                return '<div class="alert alert-info">Esta actividad no tiene preguntas.</div>';
            }

            const activityType = activityData.type || 'multiple-choice';

            // Añadir contenedor para el resumen de resultados
            let questionsHtml = `
                <div id="activity-summary-${sectionId}" class="activity-summary" style="display: none;"></div>
            `;

            activityData.questions.forEach((question, index) => {
                questionsHtml += `
                    <div class="question-card mb-3" data-question-index="${index}">
                        <p class="fw-bold mb-2">${index + 1}. ${question.text || 'Sin texto'}</p>
                `;

                // Renderizar opciones según el tipo de actividad
                switch (activityType) {
                    case 'multiple-choice':
                        if (question.options && question.options.length > 0) {
                            questionsHtml += '<div class="options-list">';
                            question.options.forEach((option, optIndex) => {
                                questionsHtml += `
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="question_${sectionId}_${index}"
                                               id="option_${sectionId}_${index}_${optIndex}" value="${optIndex}">
                                        <label class="form-check-label" for="option_${sectionId}_${index}_${optIndex}">
                                            ${option}
                                        </label>
                                    </div>
                                `;
                            });
                            questionsHtml += '</div>';
                        } else {
                            questionsHtml += '<p class="text-muted">No hay opciones definidas</p>';
                        }
                        break;

                    case 'true-false':
                        questionsHtml += `
                            <div class="options-list">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="question_${sectionId}_${index}"
                                           id="option_${sectionId}_${index}_true" value="true">
                                    <label class="form-check-label" for="option_${sectionId}_${index}_true">
                                        Verdadero
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="question_${sectionId}_${index}"
                                           id="option_${sectionId}_${index}_false" value="false">
                                    <label class="form-check-label" for="option_${sectionId}_${index}_false">
                                        Falso
                                    </label>
                                </div>
                            </div>
                        `;
                        break;

                    case 'short-answer':
                        questionsHtml += `
                            <div class="form-group">
                                <input type="text" class="form-control" name="question_${sectionId}_${index}"
                                       placeholder="Tu respuesta" style="max-width: 400px;">
                            </div>
                        `;
                        break;

                    default:
                        questionsHtml += `<p class="text-muted">Tipo de pregunta no soportado: ${activityType}</p>`;
                }

                questionsHtml += '</div>'; // Cierre de question-card
            });

            return questionsHtml;
        }
    </script>
</body>
</html>
