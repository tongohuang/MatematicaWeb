<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Curso - MatemáticaWeb</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/course.css">
    <link rel="stylesheet" href="../css/components.css">
</head>
<body>
    <div id="header"></div>

    <main class="container mt-4">
        <div id="courseContent">
            <div class="row">
                <div class="col-md-8">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h1 id="courseTitle">Cargando...</h1>
                        <a href="../index.html" class="btn btn-outline-primary">
                            <i class="fas fa-home"></i> Volver al inicio
                        </a>
                    </div>
                    <div id="courseDescription" class="mb-4"></div>

                    <div class="course-sections" id="courseSections">
                        <!-- Las secciones del curso se cargarán aquí -->
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="course-sidebar">
                        <div class="course-navigation">
                            <h4>Navegación del Curso</h4>
                            <div class="course-nav-menu" id="courseNavMenu">
                                <!-- El menú de navegación se cargará aquí -->
                                <div class="text-center">
                                    <div class="spinner-border spinner-border-sm" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                    <p class="small">Cargando contenido...</p>
                                </div>
                            </div>
                        </div>

                        <div class="course-info mt-4">
                            <h4>Información del Curso</h4>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-book"></i> <span id="topicsCount"></span> temas</li>
                                <li><i class="fas fa-puzzle-piece"></i> <span id="sectionsCount"></span> secciones</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="footer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/sample-data.js"></script>
    <script src="../js/data-persistence.js"></script>
    <script src="../js/data-manager.js"></script>
    <script src="../js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            loadComponent('header', '../components/header.html');
            loadComponent('footer', '../components/footer.html');

            // Inicializar sistema de persistencia antes de cargar los datos
            if (typeof initializeDataSystem === 'function') {
                console.log('Inicializando sistema de persistencia en courses/view.html...');
                await initializeDataSystem();
            }

            loadCourseContent();
        });

        function loadCourseContent() {
            const urlParams = new URLSearchParams(window.location.search);
            const courseId = parseInt(urlParams.get('id'));

            try {
                // Usar DataManager para obtener el curso
                const course = DataManager.getCourseById(courseId);

                if (!course) {
                    throw new Error('Curso no encontrado');
                }

                document.title = `${course.title} - MatemáticaWeb`;
                document.getElementById('courseTitle').textContent = course.title;
                document.getElementById('courseDescription').innerHTML = course.description;

                // Obtener los temas del curso
                const topics = DataManager.getTopicsByCourse(courseId);
                console.log('Temas encontrados:', topics);

                // Calcular la duración total (15 minutos por sección)
                let totalSections = 0;
                topics.forEach(topic => {
                    if (topic.sections) {
                        totalSections += topic.sections.length;
                    }
                });

                document.getElementById('topicsCount').textContent = topics.length;
                document.getElementById('sectionsCount').textContent = totalSections;

                // Cargar el menú de navegación
                loadNavigationMenu(topics);

                // Cargar temas y secciones del curso
                const topicsHtml = topics.map(topic => {
                    // Verificar si el tema tiene secciones
                    const hasSections = topic.sections && topic.sections.length > 0;

                    return `
                    <div class="course-topic-card">
                        <div class="topic-header">
                            <div class="topic-icon">
                                <i class="${topic.icon || 'fas fa-book'}"></i>
                            </div>
                            <h3 class="topic-title">${topic.title}</h3>
                        </div>
                        <div class="topic-content">
                            <p class="topic-description">${topic.description}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="badge bg-primary me-2">
                                        <i class="fas fa-puzzle-piece"></i> ${hasSections ? topic.sections.length : 0} secciones
                                    </span>
                                </div>
                                <a href="../topics/view.html?id=${topic.id}&courseId=${courseId}" class="btn btn-primary">
                                    <i class="fas fa-eye"></i> Ver tema completo
                                </a>
                            </div>
                        </div>
                    </div>
                `}).join('');

                document.getElementById('courseSections').innerHTML = topicsHtml || '<p class="text-center">Este curso aún no tiene temas.</p>';
            } catch (error) {
                console.error('Error al cargar el contenido del curso:', error);
                document.getElementById('courseTitle').textContent = 'Error al cargar el curso';
                document.getElementById('courseDescription').innerHTML = 'No se pudo cargar la información del curso.';
            }
        }

        function getSectionIcon(type) {
            switch (type) {
                case 'text':
                    return 'fas fa-align-left';
                case 'youtube':
                    return 'fab fa-youtube';
                case 'geogebra':
                    return 'fas fa-calculator';
                case 'image':
                    return 'fas fa-image';
                case 'pdf':
                    return 'fas fa-file-pdf';
                case 'activity':
                    return 'fas fa-tasks';
                default:
                    return 'fas fa-file';
            }
        }

        function getTypeName(type) {
            switch (type) {
                case 'text':
                    return 'Texto';
                case 'youtube':
                    return 'Video';
                case 'geogebra':
                    return 'GeoGebra';
                case 'image':
                    return 'Imagen';
                case 'pdf':
                    return 'PDF';
                case 'activity':
                    return 'Actividad';
                default:
                    return 'Recurso';
            }
        }

        function loadNavigationMenu(topics) {
            const navMenu = document.getElementById('courseNavMenu');
            console.log('Cargando menú de navegación con temas:', topics);

            if (!topics || topics.length === 0) {
                console.log('No se encontraron temas para el menú de navegación');
                navMenu.innerHTML = '<p class="text-muted">Este curso no tiene temas.</p>';
                return;
            }

            // Crear el menú de navegación con acordeones para cada tema
            let html = '<div class="accordion" id="courseAccordion">';

            topics.forEach((topic, index) => {
                const topicId = `topic-${topic.id}`;
                const headingId = `heading-${topic.id}`;
                const collapseId = `collapse-${topic.id}`;
                const isFirst = index === 0;

                html += `
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="${headingId}">
                            <button class="accordion-button ${isFirst ? '' : 'collapsed'}" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#${collapseId}"
                                    aria-expanded="${isFirst ? 'true' : 'false'}" aria-controls="${collapseId}">
                                <i class="${topic.icon || 'fas fa-book'} me-2"></i> ${topic.title}
                            </button>
                        </h2>
                        <div id="${collapseId}" class="accordion-collapse collapse ${isFirst ? 'show' : ''}"
                             aria-labelledby="${headingId}" data-bs-parent="#courseAccordion">
                            <div class="accordion-body p-0">
                `;

                // Verificar si el tema tiene secciones
                if (topic.sections && topic.sections.length > 0) {
                    html += '<ul class="nav flex-column nav-pills">';

                    topic.sections.forEach(section => {
                        html += `
                            <li class="nav-item">
                                <a class="nav-link" href="../sections/view.html?id=${section.id}&topicId=${topic.id}">
                                    <i class="${getSectionIcon(section.type)} me-2"></i> ${section.title}
                                </a>
                            </li>
                        `;
                    });

                    html += '</ul>';
                } else {
                    html += '<p class="text-muted p-3">Este tema no tiene secciones.</p>';
                }

                html += `
                            </div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            navMenu.innerHTML = html;
        }
    </script>
</body>
</html>