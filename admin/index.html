<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración - MatemáticaWeb</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/admin.css">

    <!-- Control de caché -->
    <script src="../js/cache-control.js"></script>
    <!-- Exportador de JSON -->
    <script src="../js/json-exporter.js"></script>
</head>
<body>
    <div id="header"></div>

    <main class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1>Panel de Administración</h1>
                    <a href="../index.html" class="btn btn-outline-primary">
                        <i class="fas fa-home"></i> Volver al inicio
                    </a>
                </div>

                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="stats-card">
                            <div class="stats-icon">
                                <i class="fas fa-book"></i>
                            </div>
                            <div class="stats-value" id="coursesCount">0</div>
                            <div class="stats-label">Cursos</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stats-card">
                            <div class="stats-icon">
                                <i class="fas fa-book-open"></i>
                            </div>
                            <div class="stats-value" id="topicsCount">0</div>
                            <div class="stats-label">Temas</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stats-card">
                            <div class="stats-icon">
                                <i class="fas fa-puzzle-piece"></i>
                            </div>
                            <div class="stats-value" id="sectionsCount">0</div>
                            <div class="stats-label">Secciones</div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Cursos Recientes</h5>
                                <a href="courses-manager.html" class="btn btn-sm btn-primary">Ver Todos</a>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Título</th>
                                                <th>Secciones</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="recentCoursesList">
                                            <!-- Los cursos recientes se cargarán aquí -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Temas Recientes</h5>
                                <a href="topic-editor.html" class="btn btn-sm btn-primary">Ver Todos</a>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Título</th>
                                                <th>Curso</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="recentActivitiesList">
                                            <!-- Las actividades recientes se cargarán aquí -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Acciones Rápidas</h5>
                            </div>
                            <div class="card-body">
                                <div class="row mb-4">
                                    <h6 class="text-muted mb-3">Gestión de Contenidos</h6>
                                    <div class="col-md-3">
                                        <a href="course-editor.html" class="btn btn-primary w-100 mb-3">
                                            <i class="fas fa-edit me-2"></i> Editor de Cursos
                                        </a>
                                    </div>
                                    <div class="col-md-3">
                                        <a href="topic-editor.html" class="btn btn-success w-100 mb-3">
                                            <i class="fas fa-book-open me-2"></i> Editor de Temas
                                        </a>
                                    </div>
                                    <div class="col-md-3">
                                        <a href="section-editor.html" class="btn btn-info w-100 mb-3">
                                            <i class="fas fa-puzzle-piece me-2"></i> Editor de Secciones
                                        </a>
                                    </div>
                                    <div class="col-md-3">
                                        <a href="resource-manager.html" class="btn btn-warning w-100 mb-3">
                                            <i class="fas fa-file me-2"></i> Gestor de Recursos
                                        </a>
                                    </div>
                                </div>

                                <div class="row">
                                    <h6 class="text-muted mb-3">Herramientas Adicionales</h6>
                                    <div class="col-md-4">
                                        <a href="site-settings.html" class="btn btn-primary w-100 mb-3">
                                            <i class="fas fa-cog me-2"></i> Configuración del Sitio
                                        </a>
                                    </div>
                                    <div class="col-md-4">
                                        <a href="activities-manager.html" class="btn btn-warning w-100 mb-3">
                                            <i class="fas fa-tasks me-2"></i> Administrar Actividades
                                        </a>
                                    </div>
                                    <div class="col-md-4">
                                        <a href="logs.html" class="btn btn-info w-100 mb-3">
                                            <i class="fas fa-list-alt me-2"></i> Registros del Sistema
                                        </a>
                                    </div>

                                    <div class="col-md-3">
                                        <a href="#" onclick="JsonExporter.updateJsonFromLocalStorage(); return false;" class="btn btn-primary w-100 mb-3">
                                            <i class="fas fa-sync-alt me-2"></i> Actualizar JSON
                                        </a>
                                    </div>
                                    <div class="col-md-3">
                                        <a href="#" onclick="JsonExporter.downloadJsonFiles(); return false;" class="btn btn-success w-100 mb-3">
                                            <i class="fas fa-download me-2"></i> Descargar JSON
                                        </a>
                                    </div>
                                    <div class="col-md-3">
                                        <a href="#" onclick="location.reload(); return false;" class="btn btn-warning w-100 mb-3">
                                            <i class="fas fa-sync me-2"></i> Recargar Página
                                        </a>
                                    </div>
                                    <div class="col-md-3">
                                        <a href="#" onclick="JsonExporter.updateSiteVersion(); return false;" class="btn btn-info w-100 mb-3">
                                            <i class="fas fa-code-branch me-2"></i> Actualizar Versión
                                        </a>
                                    </div>
                                    <div class="col-md-3">
                                        <a href="#" onclick="forceRepoDataLoad(); return false;" class="btn btn-danger w-100 mb-3">
                                            <i class="fas fa-cloud-download-alt me-2"></i> Cargar desde JSON
                                        </a>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="footer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/utils.js"></script>
    <!-- Cargar primero los scripts de datos -->
    <script src="../js/data-persistence.js"></script>
    <script src="../js/sample-data.js"></script>
    <script src="../js/data-manager.js"></script>
    <!-- Luego cargar los scripts de autenticación y funcionalidad -->
    <script src="../js/auth.js"></script>
    <script src="../js/main.js"></script>
    <script src="../js/netlify-cache-cleaner.js"></script>
    <script src="../js/json-exporter.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            loadComponent('header', '../components/header.html');
            loadComponent('footer', '../components/footer.html');

            // Verificar si el usuario está autenticado y es administrador
            if (!auth.isAdmin()) {
                window.location.href = '../login.html';
                return;
            }

            // Inicializar sistema de persistencia antes de cargar los datos
            if (typeof initializeDataSystem === 'function') {
                console.log('Inicializando sistema de persistencia en admin/index.html...');
                initializeDataSystem().then(() => {
                    // Cargar estadísticas y listas recientes una vez que el sistema de persistencia esté inicializado
                    loadStats();
                    loadRecentCourses();
                    loadRecentActivities();
                });
            } else {
                // Si no hay sistema de persistencia, cargar datos directamente
                loadStats();
                loadRecentCourses();
                loadRecentActivities();
            }
        });

        // Función para descargar los archivos JSON
        function downloadJsonFiles() {
            if (confirm('Se descargarán los archivos JSON con los datos actuales del sistema. Estos archivos deben ser subidos a la carpeta /data/ del repositorio para que Netlify los utilice.\n\n¿Desea continuar?')) {
                try {
                    // Sincronizar datos con descarga de archivos
                    DataPersistence.synchronizeData(false, true);
                    return true;
                } catch (error) {
                    console.error('Error al descargar los archivos JSON:', error);
                    alert('Error al descargar los archivos JSON. Por favor, inténtelo de nuevo.');
                    return false;
                }
            }
            return false;
        }

        // Función para forzar la carga de datos desde el repositorio
        function forceRepoDataLoad() {
            if (confirm('Esta acción cargará los datos desde los archivos JSON del repositorio, sobrescribiendo los datos locales.\n\nEsto es útil para sincronizar con los cambios realizados en Netlify o para recuperar datos perdidos.\n\n¿Desea continuar?')) {
                try {
                    // Mostrar indicador de carga
                    const loadingHtml = `
                        <div class="position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center bg-white bg-opacity-75" style="z-index: 9999;">
                            <div class="text-center">
                                <div class="spinner-border text-primary mb-3" role="status">
                                    <span class="visually-hidden">Cargando datos...</span>
                                </div>
                                <p class="mb-1">Cargando datos desde el repositorio...</p>
                                <small class="text-muted">Esto puede tardar unos segundos</small>
                            </div>
                        </div>
                    `;
                    const loadingElement = document.createElement('div');
                    loadingElement.innerHTML = loadingHtml;
                    document.body.appendChild(loadingElement.firstElementChild);

                    // Limpiar localStorage antes de cargar los datos nuevos
                    console.log('Limpiando datos locales antes de cargar desde el repositorio...');

                    // Guardar solo las claves esenciales
                    const adminSession = localStorage.getItem('admin_session');
                    const authToken = localStorage.getItem('auth_token');
                    const hideCacheBanner = localStorage.getItem('hideCacheBanner');

                    // Limpiar localStorage excepto las claves esenciales
                    const keysToKeep = ['admin_session', 'auth_token', 'hideCacheBanner'];
                    Object.keys(localStorage).forEach(key => {
                        if (!keysToKeep.includes(key)) {
                            localStorage.removeItem(key);
                        }
                    });

                    console.log('Datos locales limpiados. Cargando desde el repositorio...');

                    // Cargar los archivos JSON directamente
                    Promise.all([
                        fetch('../data/courses.json?' + Date.now()),
                        fetch('../data/topics.json?' + Date.now()),
                        fetch('../data/activities.json?' + Date.now())
                    ])
                    .then(responses => {
                        // Verificar si todas las respuestas son correctas
                        console.log('Respuestas recibidas:', responses.map(r => r.status));

                        const failedResponses = responses.filter(response => !response.ok);
                        if (failedResponses.length > 0) {
                            const statusCodes = failedResponses.map(r => r.status).join(', ');
                            throw new Error(`Error al cargar ${failedResponses.length} archivos JSON. Códigos de estado: ${statusCodes}`);
                        }

                        // Convertir todas las respuestas a JSON
                        console.log('Todas las respuestas son correctas, convirtiendo a JSON...');
                        return Promise.all(responses.map(response =>
                            response.json().catch(error => {
                                console.error(`Error al parsear JSON de ${response.url}:`, error);
                                throw new Error(`Error al parsear JSON de ${response.url}: ${error.message}`);
                            })
                        ));
                    })
                    .then(([coursesData, topicsData, activitiesData]) => {
                        console.log('Archivos JSON cargados correctamente');
                        console.log(`Cursos cargados: ${coursesData.length}`);
                        console.log(`Temas cargados: ${topicsData.length}`);

                        // Verificar si activitiesData es un objeto
                        if (typeof activitiesData !== 'object' || activitiesData === null) {
                            console.error('El archivo activities.json no contiene un objeto válido:', activitiesData);
                            activitiesData = {}; // Usar un objeto vacío como fallback
                        }

                        // Procesar actividades para asegurar que todas las claves estén normalizadas
                        const normalizedActivities = {};

                        // Si activitiesData es un array, convertirlo a objeto
                        if (Array.isArray(activitiesData)) {
                            console.log('Convirtiendo array de actividades a objeto...');
                            activitiesData.forEach(activity => {
                                if (activity && activity.id) {
                                    const normalizedId = activity.id.toString().replace('activity_', '').replace('activity_data_', '');
                                    normalizedActivities[normalizedId] = activity;
                                    normalizedActivities[`activity_${normalizedId}`] = activity;
                                    normalizedActivities[`activity_data_${normalizedId}`] = activity;
                                }
                            });
                            activitiesData = normalizedActivities;
                        } else {
                            // Si es un objeto, asegurarse de que todas las claves estén normalizadas
                            Object.entries(activitiesData).forEach(([key, activity]) => {
                                if (activity) {
                                    const normalizedId = key.toString().replace('activity_', '').replace('activity_data_', '');
                                    normalizedActivities[normalizedId] = activity;
                                    normalizedActivities[`activity_${normalizedId}`] = activity;
                                    normalizedActivities[`activity_data_${normalizedId}`] = activity;
                                }
                            });
                            activitiesData = normalizedActivities;
                        }

                        console.log(`Actividades normalizadas: ${Object.keys(activitiesData).length / 3}`);
                        console.log('Muestra de actividades:', Object.keys(activitiesData).slice(0, 9));

                        // Convertir arrays a objetos indexados por ID
                        const courses = {};
                        const topics = {};
                        const sections = {};

                        // Procesar cursos
                        coursesData.forEach(course => {
                            courses[course.id] = course;
                        });

                        // Procesar temas y extraer secciones
                        console.log('Procesando temas y extrayendo secciones...');
                        let sectionCount = 0;
                        let activitySectionCount = 0;
                        let activityFoundCount = 0;
                        let activityNotFoundCount = 0;

                        topicsData.forEach(topic => {
                            if (!topic.id) {
                                console.warn('Tema sin ID encontrado:', topic);
                                return;
                            }

                            topics[topic.id] = topic;
                            console.log(`Procesando tema: ${topic.title} (ID: ${topic.id})`);

                            // Extraer secciones
                            if (topic.sections && Array.isArray(topic.sections)) {
                                console.log(`  - El tema tiene ${topic.sections.length} secciones`);

                                topic.sections.forEach(section => {
                                    if (!section.id) {
                                        console.warn('  - Sección sin ID encontrada:', section);
                                        return;
                                    }

                                    sections[section.id] = section;
                                    sectionCount++;
                                    console.log(`  - Procesando sección: ${section.title} (ID: ${section.id}, Tipo: ${section.type})`);

                                    // Si es una sección de tipo activity, registrar la actividad
                                    if (section.type === 'activity' && section.content) {
                                        activitySectionCount++;
                                        const activityId = section.content;

                                        // Normalizar el ID de la actividad (quitar prefijos si existen)
                                        const normalizedActivityId = activityId.replace('activity_', '').replace('activity_data_', '');

                                        // Buscar la actividad en el JSON con diferentes formatos de ID
                                        let activity = activitiesData[activityId] ||
                                                      activitiesData[normalizedActivityId] ||
                                                      activitiesData[`activity_${normalizedActivityId}`] ||
                                                      activitiesData[`activity_data_${normalizedActivityId}`];

                                        if (activity) {
                                            // Guardar la actividad en localStorage con diferentes formatos para asegurar compatibilidad
                                            localStorage.setItem(`activity_${normalizedActivityId}`, JSON.stringify(activity));
                                            localStorage.setItem(`activity_data_${normalizedActivityId}`, JSON.stringify(activity));
                                            console.log(`    - Actividad ${normalizedActivityId} guardada en localStorage con múltiples formatos`);
                                            activityFoundCount++;
                                        } else {
                                            console.warn(`    - Actividad ${activityId} (normalizada: ${normalizedActivityId}) no encontrada en el JSON`);
                                            activityNotFoundCount++;
                                        }
                                    }
                                });
                            } else {
                                console.warn(`  - El tema no tiene secciones o no es un array`);
                            }
                        });

                        console.log(`Resumen de procesamiento:`);
                        console.log(`- Total de temas procesados: ${Object.keys(topics).length}`);
                        console.log(`- Total de secciones procesadas: ${sectionCount}`);
                        console.log(`- Secciones de tipo activity: ${activitySectionCount}`);
                        console.log(`- Actividades encontradas: ${activityFoundCount}`);
                        console.log(`- Actividades no encontradas: ${activityNotFoundCount}`);

                        // Guardar en el nuevo sistema de persistencia
                        console.log('Preparando datos para guardar en el sistema de persistencia...');

                        // Extraer solo las actividades únicas (sin duplicados por normalización)
                        const uniqueActivities = {};
                        const processedIds = new Set();

                        Object.entries(activitiesData).forEach(([key, activity]) => {
                            // Extraer el ID normalizado
                            const normalizedId = key.replace('activity_', '').replace('activity_data_', '');

                            // Si ya procesamos este ID, saltar
                            if (processedIds.has(normalizedId)) return;

                            // Marcar como procesado
                            processedIds.add(normalizedId);

                            // Guardar la actividad con su ID normalizado
                            uniqueActivities[normalizedId] = activity;
                        });

                        console.log(`Actividades únicas para persistencia: ${Object.keys(uniqueActivities).length}`);

                        const newData = {
                            persistent: {
                                courses,
                                topics,
                                sections,
                                activities: uniqueActivities
                            },
                            unsynced: {}
                        };

                        console.log('Estructura de datos preparada:');
                        console.log(`- Cursos: ${Object.keys(courses).length}`);
                        console.log(`- Temas: ${Object.keys(topics).length}`);
                        console.log(`- Secciones: ${Object.keys(sections).length}`);
                        console.log(`- Actividades: ${Object.keys(activitiesData).length}`);

                        try {
                            // Guardar en el nuevo sistema de persistencia
                            const newDataJson = JSON.stringify(newData);
                            console.log(`Tamaño de los datos a guardar: ${newDataJson.length} caracteres`);
                            localStorage.setItem('courseData', newDataJson);
                            console.log('Datos guardados en el nuevo sistema de persistencia');

                            // Verificar que se hayan guardado correctamente
                            const savedData = localStorage.getItem('courseData');
                            if (!savedData) {
                                console.error('Error: Los datos no se guardaron correctamente en localStorage');
                            } else {
                                console.log(`Datos verificados en localStorage: ${savedData.length} caracteres`);
                            }

                            // Guardar en el sistema antiguo para compatibilidad
                            localStorage.setItem('matematicaweb_courses', JSON.stringify(coursesData));
                            localStorage.setItem('matematicaweb_topics', JSON.stringify(topicsData));
                            console.log('Datos guardados en el sistema antiguo para compatibilidad');

                            // Paso adicional: Guardar todas las actividades directamente en localStorage
                            console.log('Guardando todas las actividades directamente en localStorage...');
                            let activityCount = 0;

                            // Recorrer todas las actividades únicas
                            Object.entries(uniqueActivities).forEach(([id, activity]) => {
                                // Asegurarse de que el ID esté normalizado
                                const normalizedId = id.replace('activity_', '').replace('activity_data_', '');

                                // Guardar con ambos formatos para asegurar compatibilidad
                                localStorage.setItem(`activity_${normalizedId}`, JSON.stringify(activity));
                                localStorage.setItem(`activity_data_${normalizedId}`, JSON.stringify(activity));
                                activityCount++;
                            });

                            console.log(`Se guardaron ${activityCount} actividades directamente en localStorage`);

                            // Verificar que se hayan guardado correctamente en el sistema antiguo
                            const savedCourses = localStorage.getItem('matematicaweb_courses');
                            const savedTopics = localStorage.getItem('matematicaweb_topics');

                            if (!savedCourses || !savedTopics) {
                                console.error('Error: Los datos no se guardaron correctamente en el sistema antiguo');
                            } else {
                                console.log(`Cursos verificados en sistema antiguo: ${savedCourses.length} caracteres`);
                                console.log(`Temas verificados en sistema antiguo: ${savedTopics.length} caracteres`);
                            }
                        } catch (error) {
                            console.error('Error al guardar datos en localStorage:', error);
                            alert('Error al guardar datos en localStorage: ' + error.message);
                        }

                        // Recargar la página para reflejar los cambios
                        alert('Datos cargados correctamente desde el repositorio. La página se recargará para mostrar los cambios.');
                        window.location.reload();
                    })
                    .catch((error) => {
                        console.error('Error al cargar datos desde el repositorio:', error);
                        alert('Error al cargar datos desde el repositorio: ' + error.message + '\n\nPor favor, inténtelo de nuevo.');

                        // Restaurar las claves esenciales
                        if (adminSession) localStorage.setItem('admin_session', adminSession);
                        if (authToken) localStorage.setItem('auth_token', authToken);
                        if (hideCacheBanner) localStorage.setItem('hideCacheBanner', hideCacheBanner);

                        // Eliminar el indicador de carga en caso de error
                        const loadingElement = document.querySelector('.bg-white.bg-opacity-75');
                        if (loadingElement) {
                            loadingElement.remove();
                        }
                    });
                    return true;
                } catch (error) {
                    // Este bloque catch solo capturará errores en la creación de la promesa, no en su ejecución
                    console.error('Error al iniciar la carga de datos:', error);
                    alert('Error al iniciar la carga de datos: ' + error.message + '\n\nPor favor, inténtelo de nuevo.');

                    // Eliminar el indicador de carga en caso de error
                    const loadingElement = document.querySelector('.bg-white.bg-opacity-75');
                    if (loadingElement) {
                        loadingElement.remove();
                    }
                    return false;
                }
            }
            return false;
        }

        function loadStats() {
            console.log('Cargando estadísticas...');

            // CARGAR DIRECTAMENTE DESDE LOCALSTORAGE - ENFOQUE SIMPLIFICADO
            let courses = [];
            let topics = [];

            try {
                console.log('Cargando datos directamente desde localStorage...');

                // 1. Obtener todos los cursos de localStorage
                courses = JSON.parse(localStorage.getItem('matematicaweb_courses') || '[]');
                console.log(`Cursos encontrados en localStorage: ${courses.length}`);

                // 2. Obtener todos los temas de localStorage
                topics = JSON.parse(localStorage.getItem('matematicaweb_topics') || '[]');
                console.log(`Temas encontrados en localStorage: ${topics.length}`);
            } catch (error) {
                console.error('Error al cargar datos desde localStorage:', error);
                // Intentar con DataManager como fallback
                if (typeof DataManager !== 'undefined') {
                    console.log('Intentando cargar datos con DataManager...');
                    courses = DataManager.getCourses();
                    topics = DataManager.getTopics();
                }
            }

            // Contar secciones
            let sectionsCount = 0;
            topics.forEach(topic => {
                if (topic.sections) {
                    sectionsCount += topic.sections.length;
                }
            });

            // Mostrar estadísticas
            document.getElementById('coursesCount').textContent = courses.length;
            document.getElementById('topicsCount').textContent = topics.length;
            document.getElementById('sectionsCount').textContent = sectionsCount;

            console.log(`Estadísticas cargadas: ${courses.length} cursos, ${topics.length} temas, ${sectionsCount} secciones`);
        }

        function loadRecentCourses() {
            console.log('Cargando cursos recientes...');
            const recentCoursesList = document.getElementById('recentCoursesList');

            // CARGAR DIRECTAMENTE DESDE LOCALSTORAGE - ENFOQUE SIMPLIFICADO
            let courses = [];
            try {
                console.log('Cargando cursos directamente desde localStorage...');

                // 1. Obtener todos los cursos de localStorage
                courses = JSON.parse(localStorage.getItem('matematicaweb_courses') || '[]');
                console.log(`Cursos encontrados en localStorage: ${courses.length}`);
            } catch (error) {
                console.error('Error al cargar cursos desde localStorage:', error);
                // Intentar con DataManager como fallback
                if (typeof DataManager !== 'undefined') {
                    console.log('Intentando cargar cursos con DataManager...');
                    courses = DataManager.getCourses();
                }
            }

            // Mostrar solo los 3 cursos más recientes (en este caso, los últimos del array)
            const recentCourses = courses.slice(-3).reverse();
            console.log(`Mostrando ${recentCourses.length} cursos recientes`);

            if (recentCourses.length === 0) {
                recentCoursesList.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center">No hay cursos disponibles</td>
                    </tr>
                `;
                return;
            }

            recentCoursesList.innerHTML = recentCourses.map(course => {
                // CARGAR DIRECTAMENTE DESDE LOCALSTORAGE - ENFOQUE SIMPLIFICADO
                let topics = [];
                try {
                    // 1. Obtener todos los temas de localStorage
                    const allTopics = JSON.parse(localStorage.getItem('matematicaweb_topics') || '[]');

                    // 2. Filtrar los temas por curso
                    topics = allTopics.filter(topic => topic.courseId == course.id);
                } catch (error) {
                    console.error(`Error al cargar temas para el curso ${course.id}:`, error);
                    // Intentar con DataManager como fallback
                    if (typeof DataManager !== 'undefined') {
                        topics = DataManager.getTopicsByCourse(course.id);
                    }
                }

                return `
                <tr>
                    <td>${course.title}</td>
                    <td>${topics.length}</td>
                    <td>
                        <a href="course-editor.html?id=${course.id}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-edit"></i>
                        </a>
                    </td>
                </tr>
                `;
            }).join('');
        }

        function loadRecentActivities() {
            console.log('Cargando actividades recientes...');
            // El título y el enlace ya están configurados correctamente en el HTML
            // No es necesario cambiarlos mediante JavaScript

            // Los encabezados de la tabla ya están configurados correctamente en el HTML

            // CARGAR DIRECTAMENTE DESDE LOCALSTORAGE - ENFOQUE SIMPLIFICADO
            let topics = [];
            try {
                console.log('Cargando temas directamente desde localStorage...');

                // 1. Obtener todos los temas de localStorage
                topics = JSON.parse(localStorage.getItem('matematicaweb_topics') || '[]');
                console.log(`Temas encontrados en localStorage: ${topics.length}`);
            } catch (error) {
                console.error('Error al cargar temas desde localStorage:', error);
                // Intentar con DataManager como fallback
                if (typeof DataManager !== 'undefined') {
                    console.log('Intentando cargar temas con DataManager...');
                    topics = DataManager.getTopics();
                }
            }

            // Mostrar solo los 3 temas más recientes
            const recentTopics = topics.slice(-3).reverse();
            console.log(`Mostrando ${recentTopics.length} temas recientes`);

            const recentActivitiesList = document.getElementById('recentActivitiesList');

            if (recentTopics.length === 0) {
                recentActivitiesList.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center">No hay temas disponibles</td>
                    </tr>
                `;
                return;
            }

            recentActivitiesList.innerHTML = recentTopics.map(topic => {
                // Obtener el curso al que pertenece el tema
                const course = DataManager.getCourseById(topic.courseId);
                const courseName = course ? course.title : 'Curso desconocido';

                return `
                <tr>
                    <td>${topic.title}</td>
                    <td>${courseName}</td>
                    <td>
                        <a href="section-editor.html?topicId=${topic.id}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-edit"></i>
                        </a>
                    </td>
                </tr>
                `;
            }).join('');
        }

        // Las funciones de administración se han movido al archivo admin-helpers.js
    </script>
</body>
</html>
