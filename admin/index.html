<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración - MatemáticaWeb</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/admin.css">
</head>
<body>
    <div id="header"></div>

    <main class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1>Panel de Administración</h1>
                    <a href="../index.html" class="btn btn-outline-primary">
                        <i class="fas fa-home"></i> Volver al inicio
                    </a>
                </div>

                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="stats-card">
                            <div class="stats-icon">
                                <i class="fas fa-book"></i>
                            </div>
                            <div class="stats-value" id="coursesCount">0</div>
                            <div class="stats-label">Cursos</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stats-card">
                            <div class="stats-icon">
                                <i class="fas fa-book-open"></i>
                            </div>
                            <div class="stats-value" id="topicsCount">0</div>
                            <div class="stats-label">Temas</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stats-card">
                            <div class="stats-icon">
                                <i class="fas fa-puzzle-piece"></i>
                            </div>
                            <div class="stats-value" id="sectionsCount">0</div>
                            <div class="stats-label">Secciones</div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Cursos Recientes</h5>
                                <a href="courses-manager.html" class="btn btn-sm btn-primary">Ver Todos</a>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Título</th>
                                                <th>Secciones</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="recentCoursesList">
                                            <!-- Los cursos recientes se cargarán aquí -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Temas Recientes</h5>
                                <a href="topic-editor.html" class="btn btn-sm btn-primary">Ver Todos</a>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Título</th>
                                                <th>Curso</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="recentActivitiesList">
                                            <!-- Las actividades recientes se cargarán aquí -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Acciones Rápidas</h5>
                            </div>
                            <div class="card-body">
                                <div class="row mb-4">
                                    <h6 class="text-muted mb-3">Gestión de Contenidos</h6>
                                    <div class="col-md-3">
                                        <a href="course-editor.html" class="btn btn-primary w-100 mb-3">
                                            <i class="fas fa-edit me-2"></i> Editor de Cursos
                                        </a>
                                    </div>
                                    <div class="col-md-3">
                                        <a href="topic-editor.html" class="btn btn-success w-100 mb-3">
                                            <i class="fas fa-book-open me-2"></i> Editor de Temas
                                        </a>
                                    </div>
                                    <div class="col-md-3">
                                        <a href="section-editor.html" class="btn btn-info w-100 mb-3">
                                            <i class="fas fa-puzzle-piece me-2"></i> Editor de Secciones
                                        </a>
                                    </div>
                                    <div class="col-md-3">
                                        <a href="resource-manager.html" class="btn btn-warning w-100 mb-3">
                                            <i class="fas fa-file me-2"></i> Gestor de Recursos
                                        </a>
                                    </div>
                                </div>

                                <div class="row">
                                    <h6 class="text-muted mb-3">Herramientas Adicionales</h6>
                                    <div class="col-md-4">
                                        <a href="site-settings.html" class="btn btn-primary w-100 mb-3">
                                            <i class="fas fa-cog me-2"></i> Configuración del Sitio
                                        </a>
                                    </div>
                                    <div class="col-md-4">
                                        <a href="activities-manager.html" class="btn btn-warning w-100 mb-3">
                                            <i class="fas fa-tasks me-2"></i> Administrar Actividades
                                        </a>
                                    </div>
                                    <div class="col-md-4">
                                        <a href="logs.html" class="btn btn-info w-100 mb-3">
                                            <i class="fas fa-list-alt me-2"></i> Registros del Sistema
                                        </a>
                                    </div>
                                    <div class="col-md-3">
                                        <a href="../netlify-cms/" class="btn btn-success w-100 mb-3">
                                            <i class="fas fa-cloud me-2"></i> CMS en la Nube
                                        </a>
                                    </div>
                                    <div class="col-md-3">
                                        <a href="#" onclick="updateJsonFromLocalStorage(); return false;" class="btn btn-primary w-100 mb-3">
                                            <i class="fas fa-sync-alt me-2"></i> Actualizar JSON
                                        </a>
                                    </div>
                                    <div class="col-md-3">
                                        <a href="#" onclick="downloadJsonFiles(); return false;" class="btn btn-success w-100 mb-3">
                                            <i class="fas fa-download me-2"></i> Descargar JSON
                                        </a>
                                    </div>
                                    <div class="col-md-3">
                                        <a href="#" onclick="forceRepoDataLoad(); return false;" class="btn btn-warning w-100 mb-3">
                                            <i class="fas fa-cloud-download-alt me-2"></i> Cargar desde JSON
                                        </a>
                                    </div>
                                    <div class="col-md-3">
                                        <a href="#" onclick="DataManager.resetData(); return false;" class="btn btn-danger w-100 mb-3">
                                            <i class="fas fa-trash me-2"></i> Reiniciar Datos
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="footer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/sample-data.js"></script>
    <script src="../js/data-persistence.js"></script>
    <script src="../js/data-manager.js"></script>
    <script src="../js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            loadComponent('header', '../components/header.html');
            loadComponent('footer', '../components/footer.html');

            // Verificar si el usuario está autenticado y es administrador
            if (!auth.isAdmin()) {
                window.location.href = '../login.html';
                return;
            }

            // Inicializar sistema de persistencia antes de cargar los datos
            if (typeof initializeDataSystem === 'function') {
                console.log('Inicializando sistema de persistencia en admin/index.html...');
                await initializeDataSystem();
            }

            // Cargar estadísticas
            loadStats();

            // Cargar listas recientes
            loadRecentCourses();
            loadRecentActivities();
        });

        // Función para descargar los archivos JSON
        function downloadJsonFiles() {
            if (confirm('Se descargarán los archivos JSON con los datos actuales del sistema. Estos archivos deben ser subidos a la carpeta /data/ del repositorio para que Netlify los utilice.\n\n¿Desea continuar?')) {
                try {
                    // Sincronizar datos con descarga de archivos
                    DataPersistence.synchronizeData(false, true);
                    return true;
                } catch (error) {
                    console.error('Error al descargar los archivos JSON:', error);
                    alert('Error al descargar los archivos JSON. Por favor, inténtelo de nuevo.');
                    return false;
                }
            }
            return false;
        }

        // Función para forzar la carga de datos desde el repositorio
        async function forceRepoDataLoad() {
            if (confirm('Esta acción cargará los datos desde los archivos JSON del repositorio, sobrescribiendo los datos locales.\n\nEsto es útil para sincronizar con los cambios realizados en Netlify o para depurar problemas.\n\n¿Desea continuar?')) {
                try {
                    // Mostrar indicador de carga
                    const loadingHtml = `
                        <div class="position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center bg-white bg-opacity-75" style="z-index: 9999;">
                            <div class="text-center">
                                <div class="spinner-border text-primary mb-3" role="status">
                                    <span class="visually-hidden">Cargando datos...</span>
                                </div>
                                <p>Cargando datos desde el repositorio...</p>
                            </div>
                        </div>
                    `;
                    const loadingElement = document.createElement('div');
                    loadingElement.innerHTML = loadingHtml;
                    document.body.appendChild(loadingElement.firstElementChild);

                    // Forzar la carga desde el repositorio
                    await DataPersistence.init(true);

                    // Recargar la página para reflejar los cambios
                    alert('Datos cargados correctamente desde el repositorio. La página se recargará para mostrar los cambios.');
                    window.location.reload();
                    return true;
                } catch (error) {
                    console.error('Error al cargar datos desde el repositorio:', error);
                    alert('Error al cargar datos desde el repositorio. Por favor, inténtelo de nuevo.');

                    // Eliminar el indicador de carga en caso de error
                    const loadingElement = document.querySelector('.bg-white.bg-opacity-75');
                    if (loadingElement) {
                        loadingElement.remove();
                    }
                    return false;
                }
            }
            return false;
        }

        function loadStats() {
            console.log('Cargando estadísticas...');

            // CARGAR DIRECTAMENTE DESDE LOCALSTORAGE - ENFOQUE SIMPLIFICADO
            let courses = [];
            let topics = [];

            try {
                console.log('Cargando datos directamente desde localStorage...');

                // 1. Obtener todos los cursos de localStorage
                courses = JSON.parse(localStorage.getItem('matematicaweb_courses') || '[]');
                console.log(`Cursos encontrados en localStorage: ${courses.length}`);

                // 2. Obtener todos los temas de localStorage
                topics = JSON.parse(localStorage.getItem('matematicaweb_topics') || '[]');
                console.log(`Temas encontrados en localStorage: ${topics.length}`);
            } catch (error) {
                console.error('Error al cargar datos desde localStorage:', error);
                // Intentar con DataManager como fallback
                if (typeof DataManager !== 'undefined') {
                    console.log('Intentando cargar datos con DataManager...');
                    courses = DataManager.getCourses();
                    topics = DataManager.getTopics();
                }
            }

            // Contar secciones
            let sectionsCount = 0;
            topics.forEach(topic => {
                if (topic.sections) {
                    sectionsCount += topic.sections.length;
                }
            });

            // Mostrar estadísticas
            document.getElementById('coursesCount').textContent = courses.length;
            document.getElementById('topicsCount').textContent = topics.length;
            document.getElementById('sectionsCount').textContent = sectionsCount;

            console.log(`Estadísticas cargadas: ${courses.length} cursos, ${topics.length} temas, ${sectionsCount} secciones`);
        }

        function loadRecentCourses() {
            console.log('Cargando cursos recientes...');
            const recentCoursesList = document.getElementById('recentCoursesList');

            // CARGAR DIRECTAMENTE DESDE LOCALSTORAGE - ENFOQUE SIMPLIFICADO
            let courses = [];
            try {
                console.log('Cargando cursos directamente desde localStorage...');

                // 1. Obtener todos los cursos de localStorage
                courses = JSON.parse(localStorage.getItem('matematicaweb_courses') || '[]');
                console.log(`Cursos encontrados en localStorage: ${courses.length}`);
            } catch (error) {
                console.error('Error al cargar cursos desde localStorage:', error);
                // Intentar con DataManager como fallback
                if (typeof DataManager !== 'undefined') {
                    console.log('Intentando cargar cursos con DataManager...');
                    courses = DataManager.getCourses();
                }
            }

            // Mostrar solo los 3 cursos más recientes (en este caso, los últimos del array)
            const recentCourses = courses.slice(-3).reverse();
            console.log(`Mostrando ${recentCourses.length} cursos recientes`);

            if (recentCourses.length === 0) {
                recentCoursesList.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center">No hay cursos disponibles</td>
                    </tr>
                `;
                return;
            }

            recentCoursesList.innerHTML = recentCourses.map(course => {
                // CARGAR DIRECTAMENTE DESDE LOCALSTORAGE - ENFOQUE SIMPLIFICADO
                let topics = [];
                try {
                    // 1. Obtener todos los temas de localStorage
                    const allTopics = JSON.parse(localStorage.getItem('matematicaweb_topics') || '[]');

                    // 2. Filtrar los temas por curso
                    topics = allTopics.filter(topic => topic.courseId == course.id);
                } catch (error) {
                    console.error(`Error al cargar temas para el curso ${course.id}:`, error);
                    // Intentar con DataManager como fallback
                    if (typeof DataManager !== 'undefined') {
                        topics = DataManager.getTopicsByCourse(course.id);
                    }
                }

                return `
                <tr>
                    <td>${course.title}</td>
                    <td>${topics.length}</td>
                    <td>
                        <a href="course-editor.html?id=${course.id}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-edit"></i>
                        </a>
                    </td>
                </tr>
                `;
            }).join('');
        }

        function loadRecentActivities() {
            console.log('Cargando actividades recientes...');
            // El título y el enlace ya están configurados correctamente en el HTML
            // No es necesario cambiarlos mediante JavaScript

            // Los encabezados de la tabla ya están configurados correctamente en el HTML

            // CARGAR DIRECTAMENTE DESDE LOCALSTORAGE - ENFOQUE SIMPLIFICADO
            let topics = [];
            try {
                console.log('Cargando temas directamente desde localStorage...');

                // 1. Obtener todos los temas de localStorage
                topics = JSON.parse(localStorage.getItem('matematicaweb_topics') || '[]');
                console.log(`Temas encontrados en localStorage: ${topics.length}`);
            } catch (error) {
                console.error('Error al cargar temas desde localStorage:', error);
                // Intentar con DataManager como fallback
                if (typeof DataManager !== 'undefined') {
                    console.log('Intentando cargar temas con DataManager...');
                    topics = DataManager.getTopics();
                }
            }

            // Mostrar solo los 3 temas más recientes
            const recentTopics = topics.slice(-3).reverse();
            console.log(`Mostrando ${recentTopics.length} temas recientes`);

            const recentActivitiesList = document.getElementById('recentActivitiesList');

            if (recentTopics.length === 0) {
                recentActivitiesList.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center">No hay temas disponibles</td>
                    </tr>
                `;
                return;
            }

            recentActivitiesList.innerHTML = recentTopics.map(topic => {
                // Obtener el curso al que pertenece el tema
                const course = DataManager.getCourseById(topic.courseId);
                const courseName = course ? course.title : 'Curso desconocido';

                return `
                <tr>
                    <td>${topic.title}</td>
                    <td>${courseName}</td>
                    <td>
                        <a href="section-editor.html?topicId=${topic.id}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-edit"></i>
                        </a>
                    </td>
                </tr>
                `;
            }).join('');
        }

        /**
         * Actualiza los archivos JSON desde localStorage
         * Esta función toma los datos actuales de localStorage y los convierte en archivos JSON
         * sin descargarlos, solo los prepara para su posterior descarga
         */
        function updateJsonFromLocalStorage() {
            console.log('Actualizando archivos JSON desde localStorage...');

            try {
                // 1. Obtener todos los datos de localStorage
                const courses = JSON.parse(localStorage.getItem('matematicaweb_courses') || '[]');
                const topics = JSON.parse(localStorage.getItem('matematicaweb_topics') || '[]');

                // 2. Convertir arrays a objetos indexados por ID para el formato que espera DataPersistence
                const coursesObj = {};
                const topicsObj = {};
                const activitiesObj = {};

                // Procesar cursos
                courses.forEach(course => {
                    coursesObj[course.id] = course;
                });

                // Procesar temas
                topics.forEach(topic => {
                    topicsObj[topic.id] = topic;
                });

                // Procesar actividades desde el registro
                try {
                    const activityRegistry = JSON.parse(localStorage.getItem('activity_registry') || '[]');
                    activityRegistry.forEach(activityInfo => {
                        const activityData = JSON.parse(localStorage.getItem(`activity_data_${activityInfo.id}`) || 'null');
                        if (activityData) {
                            activitiesObj[activityInfo.id] = activityData;
                        }
                    });
                } catch (error) {
                    console.warn('Error al procesar actividades:', error);
                }

                // 3. Crear el objeto de datos completo
                const data = {
                    courses: coursesObj,
                    topics: topicsObj,
                    activities: activitiesObj
                };

                // 4. Generar los archivos JSON (sin descargarlos)
                const success = DataPersistence.generateRepoJSON(data, false, false);

                if (success) {
                    alert('Los archivos JSON se han actualizado correctamente desde localStorage. Ahora puede descargarlos con el botón "Descargar JSON".');
                } else {
                    alert('Hubo un problema al actualizar los archivos JSON. Por favor, revise la consola para más detalles.');
                }
            } catch (error) {
                console.error('Error al actualizar archivos JSON:', error);
                alert('Error al actualizar los archivos JSON: ' + error.message);
            }
        }

        /**
         * Descarga los archivos JSON previamente generados
         */
        function downloadJsonFiles() {
            console.log('Descargando archivos JSON...');

            try {
                // Verificar si los archivos JSON están actualizados
                const lastJSONGenerationTime = localStorage.getItem('lastJSONGenerationTime');
                if (!lastJSONGenerationTime) {
                    // Si no hay archivos JSON generados, actualizarlos primero
                    if (confirm('Los archivos JSON no están actualizados. ¿Desea actualizarlos primero?')) {
                        updateJsonFromLocalStorage();
                    } else {
                        return;
                    }
                }

                // Obtener los datos JSON de localStorage
                const combinedJsonData = localStorage.getItem('jsonData_courseData');
                const coursesJsonData = localStorage.getItem('jsonData_courses');
                const topicsJsonData = localStorage.getItem('jsonData_topics');
                const settingsJsonData = localStorage.getItem('jsonData_settings');
                const activitiesJsonData = localStorage.getItem('jsonData_activities');

                // Descargar los archivos
                if (combinedJsonData) DataPersistence.downloadJsonFile(combinedJsonData, 'courseData.json', 'repository-data');
                if (coursesJsonData) DataPersistence.downloadJsonFile(coursesJsonData, 'courses.json', 'courses-data');
                if (topicsJsonData) DataPersistence.downloadJsonFile(topicsJsonData, 'topics.json', 'topics-data');
                if (settingsJsonData) DataPersistence.downloadJsonFile(settingsJsonData, 'settings.json', 'settings-data');
                if (activitiesJsonData) DataPersistence.downloadJsonFile(activitiesJsonData, 'activities.json', 'activities-data');

                alert('Se han descargado los archivos JSON. Por favor, guárdelos en las carpetas correspondientes del proyecto:\n\n- courseData.json en /data/\n- courses.json en /data/\n- topics.json en /data/\n- settings.json en /data/\n- activities.json en /data/\n\nY haga commit de los cambios.');
            } catch (error) {
                console.error('Error al descargar archivos JSON:', error);
                alert('Error al descargar los archivos JSON: ' + error.message);
            }
        }

        /**
         * Fuerza la carga de datos desde los archivos JSON del repositorio
         */
        function forceRepoDataLoad() {
            if (confirm('¿Está seguro de que desea cargar los datos desde los archivos JSON del repositorio? Esto sobrescribirá los datos actuales en localStorage.')) {
                DataPersistence.init(true);
            }
        }
    </script>
</body>
</html>
